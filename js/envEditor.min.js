!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery")):e.envEditor=t(e.jQuery)}(this,function(C){var i="undefined"!=typeof window?window.document:{},l={root:"static/plugins/envEditor/",imageDir:"images/",dataDir:"data/",enxId:null},a="envEditor";function n(){var c=this;this.Property=new function(){this.ERRCODE_SUCCESS="0x0000",this.DataList=[],this.LstNodeJson=[],this.LstLinkJson=[],this.BusyPortId=[],this.LstPortJson=[],this.ElementId="",this.Element={},this.SelectModelType=EnxHelper.ModelType.Ne,this.CurrentUser="",this.DefaultPDU="SYSTEM",this.CurrentPDU=this.DefaultPDU,this.WebsvcSuffix=".asmx",this.FileAfter=".enx",this.EnxId=EnxHelper.CreateNewGuid(),this.PostUrl=new function(){this.GetById="",this.UpdateById=""},this.GraphPlug={},this.TopoNode={},this.NetworkJson=[],this.SelectOptionValues={vmFlag:["","Fenix_GTR_4U4G100G_01","Fenix_vNE_sFTP_Tester_8U8G90G_01"],network:["","Base1","Base2","Fabric1","Fabric2","OM","External1","External2","External3","External4","External5","External6","ExternalN"],internal_external:["","InternalPort","ExternalPort"],virtual_real:["Virtual","Real"]},this.FileName="",this.ArrTestBedName=[]},this.SetData=function(e){this.ConstInfo.Reset(),this.Property.DataList=e,this.Property.TopoNode=JsonHelper.GetJsonByKey(e,EnxHelper.Field.BigType,EnxHelper.ModelType.Env),this.Property.LstNodeJson=JsonHelper.FilterListByValues(e,EnxHelper.Field.IsTopDevice,[EnxConstField.BoolStr.Yes]),this.Property.LstLinkJson=JsonHelper.FilterListByValues(e,EnxHelper.Field.BigType,[EnxHelper.ModelType.Link]),c.Property.BusyPortId=[],C.each(c.Property.LstLinkJson,function(e,t){var n=JsonHelper.GetStrValue(t[EnxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID],EnxConstField.AttrName.ENXFILE_ATTR_VALUE),r=JsonHelper.GetStrValue(t[EnxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID],EnxConstField.AttrName.ENXFILE_ATTR_VALUE);c.Property.BusyPortId.push(n),c.Property.BusyPortId.push(r)}),this.Property.LstPortJson=JsonHelper.FilterListByValues(e,EnxHelper.Field.BigType,[EnxHelper.ModelType.Port]),this.GraphEditor.Init()},this.GetObjectNameCache=function(){var o={};return c.Property.DataList&&0<c.Property.DataList.length&&C(c.Property.DataList).each(function(e,t){var n=JsonHelper.GetJsonValue(JsonHelper.GetJsonValue(t,EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME),EnxConstField.AttrName.ENXFILE_ATTR_VALUE),r=t[EnxHelper.Field.ID];o[n]=r}),o},this.Init=function(e){var t=EnxHelper.GetQueryString(c.ConstInfo.QueryStringParam.pdu),n=EnxHelper.GetQueryString(c.ConstInfo.QueryStringParam.user),r=EnxHelper.GetQueryString(c.ConstInfo.QueryStringParam.enxId);c.Property.CurrentPDU=t||c.Property.DefaultPDU;var o=c.PduRelUrl[c.Property.CurrentPDU]||c.PduRelUrl[c.Property.DefaultPDU];-1==o.indexOf(c.Property.WebsvcSuffix)?(c.Property.PostUrl.GetById=o+c.ConstInfo.QueryMethod.GetEnvContentByIdNew,c.Property.PostUrl.UpdateById=o+c.ConstInfo.QueryMethod.UpdateDataByIdNew):(c.Property.PostUrl.GetById=o+c.ConstInfo.QueryMethod.GetEnxContentById,c.Property.PostUrl.UpdateById=o+c.ConstInfo.QueryMethod.UpdateDataById),n&&(c.Property.CurrentUser=n),r&&(c.Property.EnxId=r,this.GetEnxContentByID(r)),C(i.body).addClass(a),this.OptionParam=C.extend({},l,e),c.SetData([]),this.loadLocalEnx()},this.loadLocalEnx=function(){var e=C(".EplugGraphEditorRightContainer"),t=this.OptionParam;e.showLoader(),C.get(t.root+t.dataDir+t.enxId+".enx",function(e){c.SetData(EnxHelper.EnxToLstJson(e))}).always(function(){e.hideLoader()})},this.toggleRightContainer=function(e){var i=C(".EplugGraphRightToggle"),l=C(".EplugGraphEditorResource"),a=C(".EplugGraphEditorRightContainer"),s=C(".EplugGraphEditorRightTop"),t=i.outerWidth(),p=560-t,n=i.hasClass("left"),r=function(e,t,n,r,o){a.css({"padding-right":r+p}),l.css("width",e),s.css("display",o),i[t]("left").attr("title",n)};e?n&&r(560,"removeClass","Close","+=","block"):n||r(t,"addClass","Open","-=","none")},this.GetEnxContentByID=function(e){var o=[],i="",t=c.Property.CurrentUser,n="GET",r="";-1==c.Property.PostUrl.GetById.indexOf(c.Property.WebsvcSuffix)?c.Property.PostUrl.GetById=EnxHelper.Format(c.Property.PostUrl.GetById,e):(n="POST",r=JSON.stringify({user:t,enxId:e}));var l=c.Property.PostUrl.GetById,a=r,s=JSON.stringify({"X-Auth-UserID":t}),p=C(".EplugGraphEditorRightContainer");p.showLoader(),this.RequestService(n,l,a,s,function(e){p.hideLoader();var t="";if(e&&e.resMessage&&e.errcode==c.Property.ERRCODE_SUCCESS){var n=JSON.parse(e.resMessage);if(-1==c.Property.PostUrl.GetById.indexOf(c.Property.WebsvcSuffix))n&&n.content&&(i=n.content,c.Property.FileName=n.filename,C("#txtTopoLimit").val(n.topolimit));else if(n&&n.d){var r=JSON.parse(n.d).result;r&&(i=r.enx,c.Property.FileName=r.filename)}}else t=e.errcode;t&&toastr.error(t),i&&(o=EnxHelper.EnxToLstJson(i))},function(e,t,n){p.hideLoader();var r=e.statusText;-1==c.Property.PostUrl.GetById.indexOf(c.Property.WebsvcSuffix)&&e.responseText&&(r=r+"\r\n"+(JSON.parse(e.responseText||"{}").message||""));toastr.error(r)},function(e){c.SetData(o)})},this.GetEnxContent=function(){C.each(c.Property.LstNodeJson,function(e,t){var n=t[EnxHelper.Field.ID],r=t[EnxHelper.Field.BigType],o=c.Property.GraphPlug.GetCellsByFieldValue(r,c.Property.GraphPlug.ConstInfo.AttrName.ID,n),i=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_POSITION,c.Property.GraphPlug.Translater.BondToString(o));t[EnxConstField.AttrName.ENXFILE_ATTR_POSITION]=i});var e=EnxHelper.LstJsonToEnx(c.Property.DataList);return e=e.replace(new RegExp("&lt;","gm"),"<").replace(new RegExp("&gt;","gm"),">").replace(new RegExp("★","gm"),"&quot;").replace(new RegExp("♣","gm"),"&amp;").replace(new RegExp("◀","gm"),"&lt;").replace(new RegExp("▶","gm"),"&gt;")},this.GetPostData=function(){var e=this.GetEnxContent(),t=c.Property.CurrentUser,n=C("#txtTopoLimit").val(),r={},o=c.Property.FileName?c.Property.FileName:c.Property.EnxId+c.Property.FileAfter;if(-1==c.Property.PostUrl.UpdateById.indexOf(c.Property.WebsvcSuffix))r={id:c.Property.EnxId,content:e,filename:o,userid:t,topolimit:n,testbedname:"",testbedcontent:""};else{var i=c.Property.GraphPlug.GetImageUrl();r={user:c.Property.CurrentUser,enxId:c.Property.EnxId,enxContent:e,enxImageUrl:i,fileName:o}}return r},this.SaveData=function(o){var e=c.Property.PostUrl.UpdateById,t=this.GetPostData();if(t&&t.content){var n={"X-Auth-UserID":c.Property.CurrentUser};this.RequestService("POST",e,JSON.stringify(t),JSON.stringify(n),function(e){var t="";if(e&&e.resMessage&&e.errcode==c.Property.ERRCODE_SUCCESS){var n=JSON.parse(e.resMessage);if(-1==c.Property.PostUrl.UpdateById.indexOf(c.Property.WebsvcSuffix))n.result&&"success"==n.result?(c.OpenNewUrl(),o&&toastr.success("Save successfully!")):t=n.message;else{var r=JSON.parse(n.d);r.errcode&&(t=r.errcode)}}else t=e.errcode;o&&t&&toastr.error(t)},function(e,t,n){var r=e.statusText;-1==c.Property.PostUrl.UpdateById.indexOf(c.Property.WebsvcSuffix)&&e.responseText&&(r=r+"\r\n"+(JSON.parse(e.responseText||"{}").message||""));o&&alertMsg&&toastr.error(r)})}},this.RequestService=function(e,t,n,r,o,i,l){var a=new FormData;a.append("req_type",e),a.append("service_addr",t),a.append("req_content",escape(n)),a.append("headerSet",escape(r)),C.ajax({type:"POST",url:"/Home/RequestService",data:a,dataType:"json",processData:!1,contentType:!1,success:o,error:i,complete:l})},this.ExportFile=function(){xmlContent=this.GetEnxContent();var e=new FormData;e.append("user",c.Property.CurrentUser),e.append("enxId",c.Property.EnxId),e.append("enxContent",escape(xmlContent)),C.ajax({type:"POST",url:"/Home/ExportEnxFile",data:e,dataType:"json",processData:!1,contentType:!1,success:function(e){e&&e.url&&c.OpenNewPage(e.url,void 0,!0),e&&e.errcode&&toastr.error(e.errcode)}})},this.ViewText=function(){xmlContent=this.GetEnxContent();var e=new FormData;e.append("enxId",c.Property.EnxId),e.append("enxContent",escape(xmlContent)),C.ajax({type:"POST",url:"/Home/ViewText",data:e,dataType:"json",processData:!1,contentType:!1,success:function(e){e&&C("#xmpViewText").text(e.content||e.errcode),C("#modalViewText").modal()}})},this.OpenNewPage=function(e,t,n){null!=t&&"object"==typeof t&&(e=e+"?"+C.param(t));var r="_blank";if(null!=n&&(r="_parent"),C.browser&&C.browser.mozilla)window.location=e;else{var o=i.createElement("a");o.href=e,o.target=r,o.style.display="none",i.body.appendChild(o),o.click(),i.body.removeChild(o)}},this.OpenNewUrl=function(){var e=c.Property.EnxId,t=(window.location.host,window.location.search.substr(1)),n=[],r=c.ConstInfo.QueryStringParam.enxId,o=r+"="+e;if(t){if(n=t.split("&"),t.indexOf(r)<0)n.push(o);else for(var i=0;i<n.length;i++)if(0<=n[i].indexOf(r)){n[i]=o;break}o=n.join("&")}window.location.search=o},this.GetElement=function(e){return this.Property.Element.find(e)},this.HtmlEditor=new function(){this.GetModelField=function(e,t){var n=c.ConstInfo.AvailableFiled[e];return c.ConstInfo.IsFirstInitAvailField[e]&&!t?this.InitAvailField(e):n},this.InitAvailField=function(e){var t=this.GetModelUnAvailField(e),n=this.GetModelField(e,!0),r=this.GetFirstModelEntity(e),o=JsonHelper.GetJsonAllValue(EnxHelper.Field);c.ConstInfo.IsFirstInitAvailField[e]=!1;var i,l=JsonHelper.IsJsonObj(r);for(var a in r)"string"==typeof(i=l?a:r[a])&&o.indexOf(i)<0&&t.indexOf(i)<0&&n.push(i);return n},this.GetFirstModelEntity=function(e){return c.ConstInfo.DefaultAvailField[e]},this.GetModelUnAvailField=function(e){return c.ConstInfo.UnAvailableFiled[e]}},this.GraphEditor=new function(){this.Init=function(){JsonHelper.IsEmptyJson(c.Property.GraphPlug)?c.Property.GraphPlug=new e(c):(c.Property.GraphPlug.ClearChildren(),c.Property.GraphPlug.RenderData())}},this.OptionParam={},this.PduRelUrl={SYSTEM:"http://superlab.huawei.com:7996/",SYSTEM_TEST:"http://localhost:50038/"},this.GetSpecialField=function(e){var t=[];return e==EnxHelper.ModelType.Link&&(t=JsonHelper.GetJsonAllKey(c.ConstInfo.SpecialFieldDic)),t},this.GetDisplayFieldName=function(e){var t=e;return c.ConstInfo.SpecialFieldDic[e]&&(t=c.ConstInfo.SpecialFieldDic[e]),t},this.ConstInfo=new function(){this.Reset=function(){this.IsFirstInitAvailField.Ne=!0,this.IsFirstInitAvailField.Tester=!0,this.IsFirstInitAvailField.Dev=!0,this.IsFirstInitAvailField.Atm=!0,this.IsFirstInitAvailField.Sdh=!0,this.IsFirstInitAvailField.Eth=!0,this.IsFirstInitAvailField.Board=!0,this.IsFirstInitAvailField.SubBoard=!0,this.IsFirstInitAvailField.Link=!0,this.IsFirstInitAvailField.Port=!0,this.IsFirstInitAvailField.Network=!0,this.IsFirstInitAvailField.Sftp=!0,this.IsFirstInitAvailField.Agent=!0,this.IsFirstInitAvailField.VM=!0,this.AvailableFiled.Ne=["roler"],this.Sdh=[],this.Atm=[],this.Eth=[],this.Tester=[],this.Dev=[],this.AvailableFiled.Board=[],this.AvailableFiled.SubBoard=[],this.AvailableFiled.Link=[],this.AvailableFiled.Port=[],this.Network=[],this.Sftp=[],this.Agent=[],this.AvailableFiled.VM=[]},this.REG_IP=new RegExp(/^((25[0-5]|2[0-4]\d|[01]?\d\d?)($|(?!\.$)\.)){4}$/),this.IPINPUTCLASS="EplugIpInput",this.IPINPUTINCORRECTCLASS="EplugIpInputIncorrect",this.IPINPUTINCORRECTTIP="Incorrect:",this.TableDataCheckId="data-checkIds",this.IDSelectorSingal="#",this.ClassSelectorSingal=".",this.IsFirstInitAvailField=new function(){this.Ne=!0,this.Sdh=!0,this.Atm=!0,this.Eth=!0,this.Tester=!0,this.Dev=!0,this.Board=!0,this.SubBoard=!0,this.Link=!0,this.Port=!0,this.Network=!0,this.Sftp=!0,this.Agent=!0,this.VM=!0},this.AvailableFiled=new function(){this.Ne=["roler"],this.Sdh=[],this.Atm=[],this.Eth=[],this.Tester=[],this.Dev=[],this.Board=[],this.SubBoard=[],this.Link=[],this.Port=[],this.Network=[],this.Sftp=[],this.Agent=[],this.VM=[]},this.DefaultAvailField=new function(){this.CommonAvailField=["objname","name","ip","type","version","alias","caption","is_topo","remark"],this.Ne=this.CommonAvailField.concat(["id","console","mask","username","password","ptp","vender","virtual_real","port","cmts_port","cmts_type","olt_version","sub_ip"]),this.Atm=this.CommonAvailField,this.Sdh=this.CommonAvailField,this.Eth=this.CommonAvailField.concat(["actor","bid","sbid","pid","connect_type","engrossstate","groupip","id","mac","username","password","port","portnum","ptp","realNEId","realtype","submask","vender"]),this.Board=this.CommonAvailField.concat(["angle","bid","engrossstate","username","password","portnum","realNEId","slot","virtual_real"]),this.SubBoard=this.CommonAvailField.concat(["bid","sbid","engrossstate","username","password","portnum","realNEId","submask","virtual_real"]),this.Link=this.CommonAvailField.concat(["sourcetopdevicename","sourcedeviceid","targettopdevicename","targetdeviceid","connect_type","direction","parent","cidr","start_ip","end_ip"]),this.Port=this.CommonAvailField.concat(["bid","sbid","pid","shape","submask","interface","host_id","internal_external","virtual_real"]),this.Network=this.CommonAvailField.concat(["cidr","start_ip","end_ip"]),this.VM=this.CommonAvailField.concat(["username","password","vmFlag","cpu_memory","hardDisk","mirror","virtual_real"]),this.Sftp=this.VM,this.Agent=this.VM,this.Tester=this.VM,this.Dev=this.VM},this.UnAvailableFiled=new function(){this.CommonUnAvailField=["name","guid","shape","position","class","fullclass"],this.Ne=this.CommonUnAvailField.concat(["id","bid","connect_type","mac","pid","port","portnum"]),this.Tester=this.CommonUnAvailField,this.Dev=this.CommonUnAvailField,this.Sdh=this.CommonUnAvailField,this.Atm=this.CommonUnAvailField,this.Eth=this.CommonUnAvailField,this.Board=this.CommonUnAvailField,this.SubBoard=this.CommonUnAvailField.concat(["bid"]),this.Link=this.CommonUnAvailField.concat(["dst_port","src_port"]),this.Port=this.CommonUnAvailField,this.Network=this.CommonUnAvailField,this.Sftp=this.CommonUnAvailField,this.Agent=this.CommonUnAvailField,this.VM=this.CommonUnAvailField},this.MinPageSize=10,this.CheckBoxTDFieldName="checkboxelem",this.OperationTDFieldName="operationelem",this.CombineRepalceSingal="(0*\\[[1-9]\\d*\\-[1-9]\\d*\\]|0*[1-9]\\d*\\+|0*\\*)(\\([1-9]\\d*\\))?",this.AllReplaceSingal="\\*",this.NumberRegionSingal="[1-9]\\d*",this.OccupiedPlace="0+",this.RegionReplaceSingal="\\[[1-9]\\d*\\-[1-9]\\d*\\]",this.NumAddSingal="+",this.NumAddReplaceSingal="[1-9]\\d*\\+",this.RegGM="gm",this.AddStep="(\\([1-9]\\d*\\))",this.AddSelfType={NumberAdd:"NumberAdd",Region:"Region",AutoAdd:"AutoAdd"},this.SpecialFieldDic={sourcedeviceid:"src_port",targetdeviceid:"dst_port"},this.SelectField=["vmFlag","network","internal_external","virtual_real"],this.NoEditField=["sourcetopdevicename","targettopdevicename"],this.NoEditTdClass="EPlugNoEditTd",this.QueryStringParam=new function(){this.pdu="pdu",this.user="user",this.enxId="enxId"},this.QueryMethod=new function(){this.GetEnxContentById="GetEnxContentById",this.GetEnvContentByIdNew="api/editor/v1/content/{0}",this.UpdateDataById="UpdateEnxContent",this.UpdateDataByIdNew="api/editor/v1/enx"},this.RepeatedSingal="(1)",this.RepeatedElemtClass="EPlugRepeatName",this.TIME_INTERVAL=null},this.SetNodeAttr=function(e,t,n,r){for(var o=this.GetLstByModelType(e),i=0;i<o.length;i++){if(o[i][EnxHelper.Field.ID]==t){o[i][n]=r;break}}},this.DeleteNodeAttr=function(e,t,n){for(var r=this.GetLstByModelType(e),o=0;o<r.length;o++){if(r[o][EnxHelper.Field.ID]==t){delete r[o][n];break}}},this.GetLstByModelType=function(e){var t=[];switch(e){case EnxHelper.ModelType.Ne:t=c.Property.LstNodeJson;break;case EnxHelper.ModelType.Link:t=c.Property.LstLinkJson;break;case EnxHelper.ModelType.Port:t=c.Property.LstPortJson}return t},this.CreateModel=function(o,e,i,t,n,l){var a={};a[EnxHelper.Field.BigType]=o,n||(n=EnxHelper.CreateNewGuid()),a[EnxHelper.Field.ID]=n,e&&(a[EnxHelper.Field.ParentGID]=e);var r=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_GUID,n);a[EnxConstField.AttrName.ENXFILE_ATTR_GUID]=r;var s=c.ConstInfo.DefaultAvailField[o],p=EnxHelper.GlobalVar.ElemntIndex[o];if(s){var d=c.ConstInfo.SelectField;C.each(s,function(e,t){var n="";t!=EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME&&t!=EnxConstField.AttrName.ENXFILE_ATTR_NAME||(n=c.Property.GraphPlug.ConstInfo.ElemntNamePre[o]+p,!i||o!=EnxHelper.ModelType.Board&&o!=EnxHelper.ModelType.SubBoard&&o!=EnxHelper.ModelType.Port&&o!=EnxHelper.ModelType.VM||(n=i+EnxConstField.NameSeparate+n)),-1<d.indexOf(t)&&(n=c.Property.SelectOptionValues[t][0]),JsonHelper.IsJsonObj(l)&&l[t]&&(n=l[t]);var r=EnxHelper.AttrParameter(t,n);a[t]=r})}EnxHelper.GlobalVar.ElemntIndex[o]=p+1;var E=t?t+EnxConstField.ClassSeparate:"";switch(o){case EnxHelper.ModelType.Ne:case EnxHelper.ModelType.Sftp:case EnxHelper.ModelType.Agent:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,o),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,o),c.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Network:a[EnxHelper.Field.IsTopDevice]=e&&"Env"!=t?EnxConstField.BoolStr.No:EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,o),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,o),c.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Tester:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_TESTERTYPE),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_TESTERTYPE),c.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Dev:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_DEVTYPE),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_DEVTYPE),c.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Atm:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEATM),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEATM),c.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Sdh:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPESDH),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPESDH),c.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Eth:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEETH),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEETH),c.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Link:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.No,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPECONNECT),c.Property.LstLinkJson.push(a);break;case EnxHelper.ModelType.Board:case EnxHelper.ModelType.SubBoard:case EnxHelper.ModelType.VM:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.No,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,o),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,E+o);case EnxHelper.ModelType.Port:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.No,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,o),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,E+o),c.Property.LstPortJson.push(a)}return c.Property.DataList.push(a),a},this.CopyModel=function(e,t,r,o){var i=JSON.parse(JSON.stringify(e)),l=EnxHelper.CreateNewGuid(),n=i[EnxHelper.Field.ID];i[EnxHelper.Field.ID]=l;var a=i[EnxHelper.Field.BigType];t&&(i[EnxHelper.Field.ParentGID]=t);var s=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_GUID,l);i[EnxConstField.AttrName.ENXFILE_ATTR_GUID]=s;var p=[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME,EnxConstField.AttrName.ENXFILE_ATTR_NAME],d=EnxHelper.GlobalVar.ElemntIndex[a],E=c.Property.GraphPlug.ConstInfo.ElemntNamePre[a]+d;switch(C.each(p,function(e,t){var n=E;!r||a!=EnxHelper.ModelType.Board&&a!=EnxHelper.ModelType.SubBoard&&a!=EnxHelper.ModelType.Port&&a!=EnxHelper.ModelType.VM||(n=r+EnxConstField.NameSeparate+E),i[t][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=n}),EnxHelper.GlobalVar.ElemntIndex[a]=d+1,a){case EnxHelper.ModelType.Ne:case EnxHelper.ModelType.Tester:case EnxHelper.ModelType.Dev:case EnxHelper.ModelType.Atm:case EnxHelper.ModelType.Sdh:case EnxHelper.ModelType.Eth:c.Property.LstNodeJson.push(i);break;case EnxHelper.ModelType.Link:c.Property.LstLinkJson.push(i);break;case EnxHelper.ModelType.Port:c.Property.LstPortJson.push(i);break;default:c.Property.LstNodeJson.push(i)}c.Property.DataList.push(i);var h=JsonHelper.FilterListByValues(c.Property.DataList,EnxHelper.Field.ParentGID,[n]),u=[i];return C.each(h,function(e,t){var n=c.CopyModel(t,l,E,o);u=u.concat(n)}),u},this.GetLinkByPortId=function(e){for(var t={},n=0;n<c.Property.LstLinkJson.length;n++){var r=c.Property.LstLinkJson[n];if(r.sourcedeviceid.value==e||r.targetdeviceid.value==e){t=r;break}}return t},this.RemoveModelByParentId=function(e,n){var t=this.RemoveModel(EnxHelper.Field.ParentGID,e);n&&C.each(t,function(e,t){c.RemoveModelByParentId(t,n)})},this.RemoveModel=function(r,o){var i=[],l=[];return C.each(c.Property.DataList,function(e,t){var n=t[r];"object"==typeof n&&(n=JsonHelper.GetStrValue(n,EnxConstField.AttrName.ENXFILE_ATTR_VALUE)),n!=o?i.push(t):(c.RemoveModelRelaHandler(t),l.push(JsonHelper.GetStrValue(t,EnxHelper.Field.ID)))}),c.Property.DataList=i,l},this.RemoveModelRelaHandler=function(e){var t=e[EnxHelper.Field.ID];switch(e[EnxHelper.Field.BigType]){case EnxHelper.ModelType.Ne:case EnxHelper.ModelType.Tester:case EnxHelper.ModelType.Dev:case EnxHelper.ModelType.Atm:case EnxHelper.ModelType.Sdh:case EnxHelper.ModelType.Eth:c.Property.LstNodeJson=c.JsonArrDelete(c.Property.LstNodeJson,EnxHelper.Field.ID,t);break;case EnxHelper.ModelType.Link:c.Property.LstLinkJson=c.JsonArrDelete(c.Property.LstLinkJson,EnxHelper.Field.ID,t);var n=JsonHelper.GetStrValue(e[EnxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID],EnxConstField.AttrName.ENXFILE_ATTR_VALUE),r=JsonHelper.GetStrValue(e[EnxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID],EnxConstField.AttrName.ENXFILE_ATTR_VALUE);c.Property.BusyPortId.splice(c.Property.BusyPortId.indexOf(n),1),c.Property.BusyPortId.splice(c.Property.BusyPortId.indexOf(r),1);break;case EnxHelper.ModelType.Port:if(c.Property.LstPortJson=c.JsonArrDelete(c.Property.LstPortJson,EnxHelper.Field.ID,t),-1<c.Property.BusyPortId.indexOf(t)){var o=c.GetLinkByPortId(t);c.RemoveModel(EnxHelper.Field.ID,JsonHelper.GetStrValue(o,EnxHelper.Field.ID))}}},this.GetChildrens=function(r,o){var i=[];return C.each(c.Property.DataList,function(e,t){if(t[EnxHelper.Field.ParentGID]==r&&(i.push(t),o)){var n=c.GetChildrens(t[EnxHelper.Field.ID],o);i=i.concat(n)}}),i},this.JsonArrDelete=function(e,r,o){var i=[];return C.each(e,function(e,t){var n=t[r];"object"==typeof n&&(n=JsonHelper.GetStrValue(n,EnxConstField.AttrName.ENXFILE_ATTR_VALUE)),n!=o&&i.push(t)}),i}}var e=function(u){var c=this,o=null;this.Property=new function(){this.CoreGraph={},this.Contain={},this.SelectedVertexId=[],this.SelectedLinkId=[],this.LinkGroupIndex=1,this.AssistantGraph={},this.Editor={}},this.Init=function(){if(mxClient.isBrowserSupported()){var e=this.Property.Contain=i.getElementById("EplugGraphEditorContainer"),t=this.Property.Editor=new mxEditor;(this.Property.CoreGraph=t.graph).init(e),this.BasicFixSet(),this.RenderData(),this.BindEventForMenu(),this.BindEvent(),this.InitPopMenu(),this.SubGraph.Init(),this.PropertyPanel.Init()}else mxUtils.error("Browser is not supported!",200,!1)},this.GroupLink=function(e){var t=this.GetAllLink(c.Property.CoreGraph),a=JsonHelper.FilterListByValues(t,this.ConstInfo.AttrName.ID,e),s=[];C.each(a,function(e,n){if(s.indexOf(n.id)<0){s.push(n.id);var r=n.source.id,o=n.target.id,i=[],l=n.group&&n.data.group.groupshow;C.each(a,function(e,t){t.id!=n.id&&(t.source.id==r&&t.target.id==o||t.target.id==r&&t.source.id==o)&&(l=l||t.group&&t.data.group.groupshow,i.push(t),s.push(t.id))}),l||c.CombineLinkToGroup(n,i,!1)}})},this.SubGraph=new function(){this.Graph={},this.Container={},this.EditGraphCell={};var d=this,r=null;function t(e,t){this.canSelectNode=null==e||e,this.canMoveVertet=null==t||t}this.Init=function(){d.Container=i.getElementById("EplugGraphEditorSubEditor"),d.Graph=new mxGraph(this.Container),d.BasicFixSet(),d.BindEvent(),d.ConfigureStylesheet(),d.InitPopMenu();var t=d.Graph.isCellMovable;d.Graph.isCellMovable=function(e){return t.apply(this,arguments)&&r.canMoveVertet};var n=d.Graph.isCellSelectable;d.Graph.isCellSelectable=function(e){return!(d.EditGraphCell&&d.EditGraphCell.edge&&!r.canSelectNode&&e.vertex)&&n.apply(this,arguments)}},this.BasicFixSet=function(){this.Graph.cellsResizable=!1,mxConstants.ENTITY_SEGMENT=20,this.Graph.cellsEditable=!1,this.Graph.edgeLabelsMovable=!1,this.Graph.allowDanglingEdges=!1,this.Graph.allowLoops=!1,this.Graph.setConnectable(!0),this.Graph.setDropEnabled(!0),this.Graph.setTooltips(!0),this.Graph.getTooltipForCell=function(e){return e.objname?e.objname:e.value},this.Graph.collapseToPreferredSize=!1,this.Graph.constrainChildren=!1,this.Graph.cellsSelectable=!0,this.Graph.extendParentsOnAdd=!1,this.Graph.extendParents=!1,this.Graph.border=10,this.Graph.keepEdgesInForeground=!0;var t=new mxStackLayout(this.Graph,!0);t.border=this.Graph.border,t.marginBottom=-10,new mxLayoutManager(this.Graph).getLayout=function(e){return e.collapsed?null:(e.parent!=d.Graph.model.root?(t.resizeParent=!0,t.horizontal=!1,t.spacing=10,t.x0=15):(t.resizeParent=!0,t.horizontal=!0,t.spacing=120,t.x0=0),t)},mxConstants.VERTEX_SELECTION_COLOR="#87CEEB",mxConstants.VERTEX_SELECTION_STROKEWIDTH=1.3,mxConstants.VERTEX_SELECTION_DASHED=!1,mxConstants.EDGE_SELECTION_STROKEWIDTH=1.3,mxConstants.HIGHLIGHT_STROKEWIDTH=1.3,mxEvent.disableContextMenu(this.Container),new mxCellTracker(this.Graph,"#87CEEB"),mxConstants.DROP_TARGET_COLOR="#87CEEB",mxConstants.CONNECT_HANDLE_FILLCOLOR="#87CEEB",mxConstants.HANDLE_STROKECOLOR="#87CEEB",mxRectangleShape.prototype.crisp=!0,mxGraphHandler.prototype.guidesEnabled=!0,mxGraph.prototype.expandedImage=null,mxGraph.prototype.collapsedImage=null,mxConnectionHandler.prototype.connectImage=new mxImage(c.GetImagePath("arrow.png"),20,20),this.Graph.htmlLabels=!0,this.Graph.getLabel=function(e){var t=this.labelsVisible?this.convertValueToString(e):"";if(e.vertex){var n=t.split("_");return'<div class="subgraph-item-label label-'+e.bigtype+" "+e.using+'" data-id="'+e.id+'">'+n[n.length-1]+"</div>"}return t}},this.ConfigureStylesheet=function(){var e={};e[mxConstants.STYLE_STROKECOLOR]=c.ConstInfo.LineDefualtColor,e[mxConstants.STYLE_STROKEWIDTH]=1.3,e[mxConstants.STYLE_FONTSTYLE]=2,e[mxConstants.STYLE_PERIMETER_SPACING]=0,e[mxConstants.STYLE_ENDARROW]="",e[mxConstants.STYLE_FONTCOLOR]="#5e698a",e[mxConstants.STYLE_FONTSIZE]=12,e[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_BOTTOM,e[mxConstants.STYLE_EDGE]=mxConstants.EDGESTYLE_ENTITY_RELATION,e[mxConstants.STYLE_SEGMENT]=0,this.Graph.getStylesheet().putCellStyle(EnxHelper.ModelType.Link,e)},this.SetPortStatus=function(e,t){d.Graph.getModel().beginUpdate();try{var n=t?c.ConstInfo.SwimStyle:c.ConstInfo.UsedPort;e&&(e.using=t?"":"using",d.Graph.getModel().setStyle(e,n),d.SetCellConnectable(e,t),this.EditGraphCell.vertex&&e.setConnectable(!1))}finally{d.Graph.getModel().endUpdate()}},this.SetLoopLinkPosition=function(e){d.Graph.getModel().beginUpdate();try{e.geometry.points||e.data.sourcetopdevicename.value!=e.data.targettopdevicename.value||(e.geometry.points=[new mxPoint(310,370)])}finally{d.Graph.getModel().endUpdate()}},this.ApplyPermission=function(e){r=e},this.SetNodeCannotMove=function(){this.ApplyPermission(new t(!1,!1))},this.ResetNodeMovable=function(){this.ApplyPermission(new t)},this.EditCell=function(e){d.ApplyPermission(new t),this.SetTopNav(e&&e.data),this.Graph.getModel().clear(),(this.EditGraphCell=e)&&e.vertex?this.RenderNe(e,!0,void 0,!1):e&&e.edge&&this.InitLinkEditor(e),d.ApplyPermission(new t(!0,!1))},this.SetTopNav=function(e){C(".EplugGraphEditorTopNav").css("display",e?"block":"none"),C(".EplugGraphEditorSubEditor").css("padding-top",e?191:130),C(".EplugGraphEditorTopElementName").attr("data-val",e&&e._id||"").text(e&&e.objname&&e.objname.value||"")},this.GetRootDeviceCellInfo=function(e){if(e&&e.data&&e.data.IsTopDevice==EnxConstField.BoolStr.Yes&&e.bigtype==EnxHelper.ModelType.Network)return e;var t=d.Graph.getModel().getParent(e);return!t||t.data&&t.data.IsTopDevice&&t.data.IsTopDevice==EnxConstField.BoolStr.Yes?t:t=this.GetRootDeviceCellInfo(t)},this.ConnectHandler=mxUtils.bind(this,function(e,t){var n=t.properties.edge;if(!n.target)return!1;if(n.source.bigtype==EnxHelper.ModelType.Network&&n.target.bigtype==EnxHelper.ModelType.Network)return c.Property.CoreGraph.removeCells([n]),d.Graph.removeCells([n]),toastr.warning("No connection between the network!"),!1;n.style=EnxHelper.ModelType.Link;var r=d.EditGraphCell.target.data[EnxHelper.Field.ParentGID],o=u.CreateModel(EnxHelper.ModelType.Link,r);o[EnxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=n.source.id,o[EnxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=n.target.id,u.Property.BusyPortId.push(n.source.data.guid.value),u.Property.BusyPortId.push(n.target.data.guid.value),d.SetPortStatus(n.source,!1),d.SetPortStatus(n.target,!1);var i=d.GetRootDeviceCellInfo(n.source),l=d.GetRootDeviceCellInfo(n.target);if(n.source[d.ConstInfo.ROOTDEVICE]=i.data,n.target[d.ConstInfo.ROOTDEVICE]=l.data,o[EnxConstField.AttrName.ENXFILE_ATTR_SOURCETOPDEVICENAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=i.value,o[EnxConstField.AttrName.ENXFILE_ATTR_TARGETTOPDEVICENAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=l.value,c.AttachCell(n,o),d.Graph.getModel().setValue(n,o[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]),d.SetLoopLinkPosition(n),e.connectionHandler.select=!1,d.EditGraphCell.edge){var a=c.GetAllLink(d.Graph,void 0,!0);c.RenderVirtualLink(d.EditGraphCell.source,d.EditGraphCell.target,a)}}),this.InitPopMenu=function(){d.Graph.popupMenuHandler.factoryMethod=function(e,t,n){if(t){var r=d.Graph.getSelectionCells(),o=function(e,t){C(e).find("td:last").html('<span class="mxMenu-key">'+t+"</span>")};if(1==(r=0==r.length?[t]:r).length)o(e.addItem("Edit",null,function(){c.PropertyPanel.EditNodeById(r[0].id)},null,"mxMenu edit"),"Enter");o(e.addItem("Delete",null,function(){d.RemoveSelectCell(r)},null,"mxMenu delete"),"Del")}}},this.RemoveSelectCell=function(e){if(0!=(e=e||d.Graph.getSelectionCells()).length){C.each(e,function(e,t){d.RemoveCellRel(t),u.RemoveModelByParentId(t.id,!0),u.RemoveModel(EnxHelper.Field.ID,t.id),u.Property.GraphPlug.RemoveCellById(t.bigtype,t.id)});var t=e[0];t&&t.vertex&&"yes"!=t.data.IsTopDevice&&c.Property.CoreGraph.fireEvent(new mxEventObject(mxEvent.CLICK,"event",null,"cell",d.EditGraphCell)),d.Graph.removeCells(e),0==d.Graph.getChildVertices().length&&d.SetTopNav()}},this.RemoveCellRel=function(e){if(e.edge)return d.SetPortStatus(e.target,!0),void d.SetPortStatus(e.source,!0);var t=[];if(e.bigtype==EnxHelper.ModelType.Port&&-1<u.Property.BusyPortId.indexOf(e.id))t.push(e);else{var n=c.GetAllNode(d.Graph,e,!0);t=C.grep(n,function(e,t){return e.bigtype==EnxHelper.ModelType.Port&&-1<u.Property.BusyPortId.indexOf(e.id)})}0!=t.length&&C.each(t,function(e,n){var t=C.grep(u.Property.LstLinkJson,function(e,t){return e.sourcedeviceid.value==n.id||e.targetdeviceid.value==n.id});if(t&&0!=t.length){var r=t[0]._id;c.RemoveCellById(EnxHelper.ModelType.Link,r),u.RemoveModel(EnxHelper.Field.ID,r)}})},this.InitLinkEditor=function(e){d.Graph.removeListener(d.ConnectHandler);var t,n=e.source,r=e.target;if(t=n.id!=r.id?2:1,this.RenderNe(n,!0,t,!0),n.id!=r.id){this.RenderNe(r,!0,t,!0);var o=d.Graph.getModel().getEdgesBetween(n,r,!1);d.CopyLinkFromCoreGraph(o)}else{var i=d.Graph.getModel().getEdgesBetween(n,n,!1);d.CopyLinkFromCoreGraph(i)}d.Graph.addListener(mxEvent.CELL_CONNECTED,d.ConnectHandler)},this.CopyLinkFromCoreGraph=function(e){if(e&&0<e.length){var s={},t=c.GetAllNode(d.Graph,void 0,!0);C.each(t,function(e,t){t.bigtype!=EnxHelper.ModelType.Port&&t.bigtype!=EnxHelper.ModelType.Network||(s[t.data.guid.value]=t)});var p=d.Graph.getDefaultParent();d.Graph.getModel().beginUpdate();try{C.each(e,function(e,t){var n=t.data;if(n){var r=n[EnxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],o=n[EnxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],i=s[r],l=s[o];if(i&&l){d.SetCellConnectable(i,!1),d.SetCellConnectable(l,!1),i[d.ConstInfo.ROOTDEVICE]=t.source.data,l[d.ConstInfo.ROOTDEVICE]=t.target.data;var a=d.Graph.insertEdge(p,t.id,t.objname,s[r],s[o],EnxHelper.ModelType.Link);c.AttachCell(a,t.data),d.SetLoopLinkPosition(a)}}})}finally{d.Graph.getModel().endUpdate()}}},this.SetCellConnectable=function(e,t){e&&e.bigtype!=EnxHelper.ModelType.Network&&e.setConnectable(t)},this.RenderNe=function(e,t,n,r){var o={},i=d.Graph.getDefaultParent();d.Graph.getModel().beginUpdate();try{if(t){var l=JsonHelper.GetJsonByKey(u.Property.LstNodeJson,EnxHelper.Field.ID,e.id),a=d.GetBond(l.BigType),s=c.Translater.JsonToCell(d.Graph,l,i,a,c.ConstInfo.SwimStyle);l.BigType==EnxHelper.ModelType.Network?s.setConnectable(r):s.setConnectable(!1),o=s,-1<u.Property.BusyPortId.indexOf(l.guid.value)&&(s.setConnectable(!1),s.using="using")}else o=i;d.RenderChildCell(e,o,t,n,r)}finally{d.Graph.getModel().endUpdate()}},this.GetBond=function(e){var t=d.ConstInfo.ElementDeaultSet[e];return[0,0,t?t.Width:90,30]},this.RenderChildCell=function(e,i,l,a,s){var t=JsonHelper.GetStrValue(e,c.ConstInfo.AttrName.ID),n=JsonHelper.FilterListByValues(u.Property.DataList,EnxHelper.Field.ParentGID,[t]);C.each(n,function(e,t){if(l&&t.BigType==EnxHelper.ModelType.Port&&t.internal_external&&t.internal_external.value){var n=t.internal_external.value.toLowerCase().indexOf("external");if(1==a&&-1<n)return!0;if(2==a&&-1==n)return!0}var r=d.ConstInfo.ElementDeaultSet[t.BigType].Width,o=c.Translater.JsonToCell(d.Graph,t,i,[0,0,r,30],c.ConstInfo.SwimStyle,l);t.BigType==EnxHelper.ModelType.Network?o.setConnectable(l&&s):o.setConnectable(t.BigType==EnxHelper.ModelType.Port&&l&&s&&u.Property.BusyPortId.indexOf(t.guid.value)<0),-1<u.Property.BusyPortId.indexOf(t.guid.value)&&(d.Graph.getModel().setStyle(o,c.ConstInfo.UsedPort),o.using="using"),d.RenderChildCell(o,o,l,a,s)})},this.BindEvent=function(){d.Graph.addListener(mxEvent.CLICK,function(e,t){c.EditType=c.ConstInfo.EnumEditType.Element,t.properties.cell||c.PropertyPanel.Hide()}),C(".tools-delete").off("click").click(function(){d.RemoveSelectCell()})},this.ConstInfo=new function(){this.ElementDeaultSet=new function(){this.Ne={Width:200},this.Tester={Width:200},this.Dev={Width:200},this.Atm={Width:200},this.Sdh={Width:200},this.Eth={Width:200},this.Sftp={Width:200},this.Network={Width:105},this.Agent={Width:200},this.Board={Width:160},this.VM={Width:160},this.SubBoard={Width:140},this.Port={Width:90}},this.ROOTDEVICE="rootdevice"},this.InsertCell=function(e,t){var n=c.GetAllNode(d.Graph,null,!0),r=JsonHelper.GetJsonByKey(n,c.ConstInfo.AttrName.ID,t);JsonHelper.IsEmptyJson(r)||(c.SubGraph.ResetNodeMovable(),c.ExcuteDropInElement(d.Graph,r,e,[],c.ConstInfo.SwimStyle))}},this.ToggleToolBar=function(e){c.EditType==c.ConstInfo.EnumEditType.Topo?c.EditType=c.ConstInfo.EnumEditType.Element:c.EditType=c.ConstInfo.EnumEditType.Topo,C(".EplugGraphEditorElementItem").hide(),C(".EplugGraphEditorElementItem[data-edittype='"+c.EditType+"']").show(),C(".EplugGraphEditorElementItem[data-edittype='"+c.ConstInfo.EnumEditType.Network+"']").show(),C(".EplugGraphEditorTopMenu span").show(),C(".EplugGraphEditorTopMenu span[data-hidetype='"+c.EditType+"']").hide(),c.EditType!=c.ConstInfo.EnumEditType.Element||!e||e!=EnxHelper.ModelType.Tester&&e!=EnxHelper.ModelType.Dev&&e!=EnxHelper.ModelType.Sftp&&e!=EnxHelper.ModelType.Agent||(C(".EplugGraphEditorElementItem").hide(),C(".EplugGraphEditorElementItem[data-type='Port']").show())},this.PropertyPanel=new function(){var h=this;this.EditNodeJson={},this.CustomFields={},this.ElementId="EplugGraphEditorPropertyEditPanel",this.HtmlTemplate=new function(){this.FieldEditItem='<tr data-fieldname="{0}"><td class="EplugGraphEditorPropertyPanelFieldTitle EPlugTextEllipsis">{1}:</td><td><input value="{2}" type="text" class="field_value" /></td></tr>',this.FieldShowItem='<tr data-fieldname="{0}"><td class="EplugGraphEditorPropertyPanelFieldTitle EPlugTextEllipsis">{1}:</td><td><label class="EPlugTextEllipsis EplugGraphEditorPropertyPanelFieldLink" title="{3}" data-val="{2}">{3}</label></td></tr>',this.FieldEditSelItem='<tr data-fieldname="{0}"><td class="EplugGraphEditorPropertyPanelFieldTitle EPlugTextEllipsis">{1}:</td><td><select>{2}</select></td></tr>',this.SelectOptionItem='<option value="{0}" {2}>{1}</option>',this.FieldEditCustomItem='<tr class="custom_field" data-fieldname="{0}"><td><input type="text" class="custom_field_key" placeholder="Key" value="{0}" /><span>:</span></td><td><input type="text" class="custom_field_value field_value" placeholder="Value" value="{1}" /><span class="glyphicon glyphicon-plus custom_field_add" aria-hidden="true" title="Add"></span><span class="glyphicon glyphicon-minus custom_field_delete" aria-hidden="true" title="Delete"></span></td></tr>'},this.Init=function(){this.BindEvent()},this.GetElement=function(e){return C("#"+h.ElementId).find(e)},this.BindEvent=function(){h.GetElement(".EplugGraphEditorPropertyPanelTitleBtn").off("click").click(function(){h.Hide()}),C("#"+h.ElementId).off("change").on("change","input,select",function(){h.updateProperties()})},this.updateProperties=function(){var e=h.GetNodeJson();if(!JsonHelper.IsEmptyJson(e)){C.each(h.CustomFields,function(e,t){delete h.EditNodeJson[e]});var t=JsonHelper.JsonArrSingleUpdate(u.Property.DataList,EnxHelper.Field.ID,EnxConstField.AttrName.ENXFILE_ATTR_VALUE,h.EditNodeJson._id,e);u.Property.GraphPlug.UpdateCell(h.EditNodeJson.BigType,t)}},this.GetNodeJson=function(){var s={};return h.GetElement(".EplugGraphEditorPropertyPanelLst tr").each(function(e,t){var n,r=C(this),o=r.attr("data-fieldname");if(o){var i=r.find("input.field_value");if(0<i.length&&(n=C.trim(i.val()),o==EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME)){var l=u.GetObjectNameCache();l[n]&&l[n]!=h.EditNodeJson._id&&(n+=u.ConstInfo.RepeatedSingal,i.val(n))}var a=C(this).find("select");0<a.length&&(n=a.val()),void 0!==n&&(s[o]=n)}}),s},this.Show=function(){C("#"+h.ElementId).show(200)},this.Hide=function(){this.Reset(),C("#"+h.ElementId).hide(200)},this.Reset=function(){h.GetElement(".EplugGraphEditorPropertyPanelLst").empty()},this.AddField=function(e){var t=EnxHelper.Format(h.HtmlTemplate.FieldEditItem,e,e,"");h.GetElement(".EplugGraphEditorPropertyPanelLst").append(t)},this.AddTr=function(e){h.GetElement(".EplugGraphEditorPropertyPanelLst").append(e)},this.EditNodeById=function(e){if(e&&(h.EditNodeJson=JsonHelper.GetJsonByKey(u.Property.DataList,EnxHelper.Field.ID,e),!JsonHelper.IsEmptyJson(h.EditNodeJson))){h.Show(),h.Reset();var t=h.EditNodeJson.BigType,n=u.HtmlEditor.GetModelField(t),d=u.GetSpecialField(t),E=u.ConstInfo.SelectField;C.each(n,function(e,t){var n=u.GetDisplayFieldName(t),r=JsonHelper.GetJsonValue(h.EditNodeJson,t),o=JsonHelper.GetStrValue(r,EnxConstField.AttrName.ENXFILE_ATTR_VALUE).replace(new RegExp('"',"gm"),"&quot;"),i=o,l="";if(u.ConstInfo.NoEditField.indexOf(t)<0){if(-1<d.indexOf(t)){var a=JsonHelper.GetJsonByKeyAndSecondKey(u.Property.LstPortJson,EnxConstField.AttrName.ENXFILE_ATTR_GUID,EnxConstField.AttrName.ENXFILE_ATTR_VALUE,o);JsonHelper.IsEmptyJson(a)||(i=a[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]),l=C(EnxHelper.Format(h.HtmlTemplate.FieldShowItem,t,n,o,i)),h.BindEventForLink(l)}else if(-1<E.indexOf(t)){var s="",p=u.Property.SelectOptionValues[t];C.each(p,function(e,t){s+=i&&i==t?EnxHelper.Format(h.HtmlTemplate.SelectOptionItem,t,t,"selected='selected'"):EnxHelper.Format(h.HtmlTemplate.SelectOptionItem,t,t,"")}),l=C(EnxHelper.Format(h.HtmlTemplate.FieldEditSelItem,t,n,s))}else l=C(EnxHelper.Format(h.HtmlTemplate.FieldEditItem,t,n,o));h.AddTr(l)}});var r=JsonHelper.GetJsonAllKey(h.EditNodeJson),o=u.HtmlEditor.GetModelUnAvailField(t);o=o.concat(JsonHelper.GetJsonAllValue(EnxHelper.Field),n);var i=C.grep(r,function(e){return-1==C.inArray(e,o)});h.CustomFields={},C.each(i,function(e,t){h.CustomFields[t]=h.EditNodeJson[t].value}),h.InitCustomFields()}},this.BindEventForLink=function(e){e.find(".EplugGraphEditorPropertyPanelFieldLink").off("click").click(function(){var e=C(this).attr("data-val");h.EditNodeById(e)})},this.InitCustomFields=function(){var e=h.CustomFields;C.isEmptyObject(e)?h.AddCustomField():C.each(e,function(e,t){h.AddCustomField(void 0,e,t)})},this.AddCustomField=function(e,t,n){var r=C(EnxHelper.Format(h.HtmlTemplate.FieldEditCustomItem,t||"",n||""));e?e.after(r):h.AddTr(r),h.BindEventForCustomOps(r)},this.BindEventForCustomOps=function(t){t.off("click").on("click",".custom_field_add,.custom_field_delete",function(){C(this).hasClass("custom_field_add")?h.AddCustomField(t):(t.remove(),h.updateProperties())}),t.off("change").on("change",".custom_field_key",function(){var e=C.trim(C(this).val());e&&t.attr("data-fieldname",e)})}},this.GetDisplayNodeName=function(e,t){if(!JsonHelper.IsEmptyJson(e)){var n=e[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],r=JsonHelper.GetJsonValue(e,EnxConstField.AttrName.ENXFILE_ATTR_ROLER)[EnxConstField.AttrName.ENXFILE_ATTR_VALUE],o=n;if(e.BigType==EnxHelper.ModelType.Ne&&r&&(o+="("+r+")"),t&&e.BigType==EnxHelper.ModelType.Port){var i=JsonHelper.GetJsonValue(e,EnxConstField.AttrName.ENXFILE_ATTR_INTERFACE)[EnxConstField.AttrName.ENXFILE_ATTR_VALUE];i&&(o=i)}return o}},this.RenderData=function(){this.Property.CoreGraph.getModel().beginUpdate();var p=this.Property.CoreGraph.getDefaultParent();p[this.ConstInfo.AttrName.CANVASID]=u.Property.TopoNode._id,p[this.ConstInfo.AttrName.BIGTYPE]=u.Property.TopoNode.BigType;try{var d={};C.each(u.Property.LstNodeJson,function(e,t){var n=c.Translater.JsonToCell(c.Property.CoreGraph,t,p),r=t[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE];d[r]=n}),C.each(u.Property.LstLinkJson,function(e,t){var n=JsonHelper.GetJsonValue(t,EnxConstField.AttrName.ENXFILE_ATTR_SOURCETOPDEVICENAME)[EnxConstField.AttrName.ENXFILE_ATTR_VALUE],r=JsonHelper.GetJsonValue(t,EnxConstField.AttrName.ENXFILE_ATTR_TARGETTOPDEVICENAME)[EnxConstField.AttrName.ENXFILE_ATTR_VALUE],o=JsonHelper.GetJsonValue(d,n),i=JsonHelper.GetJsonValue(d,r);if(JsonHelper.IsEmptyJson(o)&&JsonHelper.IsEmptyJson(i))return!0;var l=t[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],a=t[EnxHelper.Field.ID];if(c.InsertLink(p,a,l,o,i,EnxHelper.ModelType.Link,t),t.group){var s=t.group.value;c.ResetMaxGroupIndex(s)}})}finally{this.Property.CoreGraph.getModel().endUpdate()}},this.RenderVirtualLink=function(i,l,a){var e=this.GetLinksBetween(i,l,!1),s=this.Property.CoreGraph,p=this;if(s.removeCells(e),a){var d=s.getDefaultParent();s.getModel().beginUpdate();try{C.each(a,function(e,t){var n=t.source.rootdevice._id==i.id?i:l,r=t.target.rootdevice._id==l.id?l:i,o=c.InsertLink(d,t.id,t.objname,n,r,EnxHelper.ModelType.Link,t.data);e==a.length-1&&(s.setSelectionCell(o),p.SubGraph.SetTopNav(o.data))})}finally{s.getModel().endUpdate()}}},this.GetLinksBetween=function(e,t,n){var r=[];r=this.Property.CoreGraph.getModel().getEdgesBetween(e,t,!1);if(n){var o=this.Property.CoreGraph.getModel().getEdgesBetween(e,e,!1);r=r.concat(o);var i=this.Property.CoreGraph.getModel().getEdgesBetween(t,t,!1);r=r.concat(i)}return r},this.RemoveLink=function(n,r){this.Property.CoreGraph.removeCells([n]);var e=this.Property.CoreGraph.getModel().getEdgesBetween(n.source,n.target,!1),o=n.data&&n.data.group&&n.data.group.groupshow,i=[];C.each(e,function(e,t){o&&t.data.group&&t.data.group.value==n.data.group.value&&(r?(c.RemoveLink(t),u.RemoveModel(EnxHelper.Field.ID,t.id)):i.push(t.id))}),0<i.length&&c.GroupLink(i)},this.AttachCell=function(e,t){var n=t[EnxHelper.Field.ID],r=t[EnxHelper.Field.BigType],o=t[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE];e[c.ConstInfo.AttrName.BIGTYPE]=r,e[c.ConstInfo.AttrName.OBJNAME]=o,e[c.ConstInfo.AttrName.DATA]=t,e[c.ConstInfo.AttrName.CANVASID]=n,e[c.ConstInfo.AttrName.ID]=n},this.ResetMaxGroupIndex=function(e){var t=e.match(new RegExp("0|[1-9]\\d*","gm"));t&&0<t.length&&this.Property.LinkGroupIndex<=parseInt(t[t.length-1])&&(this.Property.LinkGroupIndex=parseInt(t[t.length-1])+1)},this.Translater=new function(){this.FixFlex=new function(){this.XAdd=5,this.YAdd=25},this.GetJsonBond=function(e){var t=[0,0,c.ConstInfo.FixWidth,c.ConstInfo.FixHeight],n=JsonHelper.GetJsonValue(e,EnxConstField.AttrName.ENXFILE_ATTR_POSITION)[EnxConstField.AttrName.ENXFILE_ATTR_VALUE];if(n&&-1<n.indexOf(";")){var r=n.split(";"),o=0,i=0;if(-1<r[0].indexOf(",")){var l=r[0].split(",");o=parseInt(l[0])-this.FixFlex.XAdd,i=parseInt(l[1])-this.FixFlex.YAdd}if(-1<r[1].indexOf(",")){var a=r[1].split(",");parseInt(a[0])-this.FixFlex.XAdd,parseInt(a[1])-this.FixFlex.YAdd}t[0]=o,t[1]=i,t[2]=62,t[3]=62}return t},this.BondToString=function(e){var t=e[c.ConstInfo.AttrName.GEOMETRY];t||(t={x:0,y:0,width:0,height:0});var n=t.x+this.FixFlex.XAdd,r=t.y+this.FixFlex.YAdd;return n+","+r+";"+(n+t.width)+","+(r+t.height)},this.JsonToCell=function(e,t,n,r,o,i){if(!C.isEmptyObject(t)){var l=r;r&&0!=r.length||(l=c.Translater.GetJsonBond(t));var a=t[EnxHelper.Field.ID],s=c.GetDisplayNodeName(t,i),p=t[EnxHelper.Field.BigType],d=(t[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],e.insertVertex(n,a,s,l[0],l[1],l[2],l[3],o||p));return c.AttachCell(d,t),d}}},this.GetImagePath=function(e){var t=u.OptionParam;return t.root+t.imageDir+e},this.ConfigureStylesheet=function(){var e={};e[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_IMAGE,e[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-ne.png"),e[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_TOP,e[mxConstants.STYLE_VERTICAL_LABEL_POSITION]=mxConstants.ALIGN_BOTTOM,e[mxConstants.STYLE_FONTCOLOR]="#333",this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Ne,e);var t=C.extend({},e);t[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-tester.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Tester,t);var n=C.extend({},e);n[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-tester.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Dev,n);var r=C.extend({},e);r[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-atm.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Atm,r);var o=C.extend({},e);o[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-eth.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Eth,o);var i=C.extend({},e);i[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-sdh.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Sdh,i);var l=C.extend({},e);l[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-sftp.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Sftp,l);var a=C.extend({},e);a[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-agent.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Agent,a);var s=C.extend({},e);s[mxConstants.STYLE_IMAGE]=this.GetImagePath("v-network.png"),this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Network,s);var p={};p[mxConstants.STYLE_STROKECOLOR]=c.ConstInfo.LineDefualtColor,p[mxConstants.STYLE_STROKEWIDTH]=1.3,p[mxConstants.STYLE_FONTSTYLE]=2,p[mxConstants.STYLE_PERIMETER_SPACING]=1,p[mxConstants.STYLE_ENDARROW]="",p[mxConstants.STYLE_FONTCOLOR]="#5e698a",p[mxConstants.STYLE_FONTSIZE]=12,p[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_BOTTOM,this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Link,p);var d=C.extend({},p);d[mxConstants.STYLE_CURVED]=!0,this.Property.CoreGraph.getStylesheet().putCellStyle(c.ConstInfo.LoopLinkStyleName,d);var E=C.extend({},p);E[mxConstants.STYLE_CURVED]=!0,E[mxConstants.STYLE_STROKEWIDTH]=1.3,E[mxConstants.STYLE_STROKECOLOR]="#525ae9",this.Property.CoreGraph.getStylesheet().putCellStyle(c.ConstInfo.LoopGroupLinkStyleName,E);var h=C.extend({},p);h[mxConstants.STYLE_DASHED]=1,this.Property.CoreGraph.getStylesheet().putCellStyle(c.ConstInfo.VirtualLinkStyleName,h)},this.GetAllNode=function(r,e,o){var t=e||r.getDefaultParent(),i=r.getModel().getChildVertices(t);return o&&i&&0<i.length&&C.each(i,function(e,t){var n=c.GetAllNode(r,t,o);i=i.concat(n)}),i},this.GetAllLink=function(r,e,o){var i=[],t=e||r.getDefaultParent();i=r.getModel().getChildEdges(t);if(o){var n=r.getModel().getChildVertices(t);C.each(n,function(e,t){var n=c.GetAllLink(r,t,o);i=i.concat(n)})}return i},this.GetCellsByFieldValue=function(e,t,n){var r=[];switch(e){case EnxHelper.ModelType.Ne:case EnxHelper.ModelType.Tester:case EnxHelper.ModelType.Dev:case EnxHelper.ModelType.Sdh:case EnxHelper.ModelType.Atm:case EnxHelper.ModelType.Eth:case EnxHelper.ModelType.Board:case EnxHelper.ModelType.SubBoard:case EnxHelper.ModelType.Port:r=this.GetAllNode(c.Property.CoreGraph);break;case EnxHelper.ModelType.Link:r=this.GetAllLink(c.Property.CoreGraph);break;default:r=this.GetAllNode(c.Property.CoreGraph)}return JsonHelper.GetJsonByKey(r,t,n)},this.UpdateCell=function(e,t){var n,r=JsonHelper.GetStrValue(t,EnxHelper.Field.ID),o=t.IsTopDevice==EnxConstField.BoolStr.Yes,i=e==EnxHelper.ModelType.Link;if(o||i)n=c.GetCellsByFieldValue(e,c.ConstInfo.AttrName.ID,r);else{var l=c.GetAllNode(c.SubGraph.Graph,null,!0);n=JsonHelper.GetJsonByKey(l,c.ConstInfo.AttrName.ID,t._id)}if(!JsonHelper.IsEmptyJson(n)){var a=n.objname!=t.objname.value;o&&a&&c.UpdateCellRelChildren(r,n.objname,t.objname.value);var s=c.GetDisplayNodeName(t);n[c.ConstInfo.AttrName.OBJNAME]=t[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],n[c.ConstInfo.AttrName.DATA]=t,c.Property.CoreGraph.getModel().setValue(n,s),c.SubGraph.Graph.getModel().setValue(n,s),(o&&a||i)&&c.SubGraph.EditCell(n)}},this.UpdateCellRelChildren=function(e,r,o){var t=u.GetChildrens(e,!0);C.each(t,function(e,t){var n=t.objname.value;0==n.indexOf(r)&&n.substr(r.length,1)==EnxConstField.NameSeparate&&(n=n.replace(r,o)),t[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=n,c.UpdateCell(t.BigType,t)})},this.BasicFixSet=function(){this.Property.CoreGraph.cellsResizable=!1,this.Property.CoreGraph.cellsEditable=!1,this.Property.CoreGraph.edgeLabelsMovable=!1,this.Property.CoreGraph.allowDanglingEdges=!1,this.Property.CoreGraph.allowLoops=!0,this.Property.CoreGraph.setConnectable(!0),this.Property.CoreGraph.setDropEnabled(!0),this.Property.CoreGraph.setTooltips(!0);var t=new mxParallelEdgeLayout(this.Property.CoreGraph);new mxLayoutManager(this.Property.CoreGraph).getLayout=function(e){if(0<e.getChildCount())return t},new mxRubberband(this.Property.CoreGraph),c.ConfigureStylesheet(),mxConstants.DEFAULT_FONTFAMILY="Helvetica,Arial",mxConstants.VERTEX_SELECTION_COLOR="#87CEEB",mxConstants.VERTEX_SELECTION_STROKEWIDTH=1.3,mxConstants.VERTEX_SELECTION_DASHED=!1,mxConstants.EDGE_SELECTION_COLOR="#87CEEB",mxConstants.EDGE_SELECTION_DASHED=!1,mxConstants.EDGE_SELECTION_STROKEWIDTH=1.3,mxConstants.DEFAULT_FONTSIZE=14,mxConstants.HIGHLIGHT_STROKEWIDTH=1.3,mxConstants.LOCKED_HANDLE_FILLCOLOR="#87CEEB",mxConstants.HANDLE_STROKECOLOR="#87CEEB",mxEvent.disableContextMenu(this.Property.Contain),new mxCellTracker(this.Property.CoreGraph,"#87CEEB"),mxCellHighlight.prototype.spacing=0,this.Property.CoreGraph.setCellsResizable(!1),this.Property.CoreGraph.setCellsBendable(!1),delete this.Property.CoreGraph.getStylesheet().getDefaultEdgeStyle().endArrow,mxRectangleShape.prototype.crisp=!0,mxGraphHandler.prototype.guidesEnabled=!0,this.PermissionApply(new this.Permission(!1),this.Property.CoreGraph),this.ExtendsHook(this.Property.CoreGraph),this.Property.CoreGraph.getTooltipForCell=function(e){if(e.vertex){var t=e.data;return'<ul class="core_tip"><li><span class="tip_title">Name:</span><span>'+t.objname.value+'</span></li><li><span class="tip_title">IP:</span><span>'+t.ip.value+'</span></li><li><span class="tip_title">Type:</span><span>'+t.type.value+"</span></li></ul>"}return e.value},this.IconSet(this.Property.CoreGraph)},this.IconSet=function(r){function n(t){this.images=[];t.view.graph;var e=mxUtils.createImage(c.GetImagePath("edit.png"));e.setAttribute("title","Edit"),e.style.position="absolute",e.style.cursor="pointer",e.style.width="20px",e.style.height="20px",e.style.left=t.x+t.width+"px",e.style.top=t.y-16+"px",mxEvent.addGestureListeners(e,mxUtils.bind(this,function(e){mxEvent.consume(e)})),mxEvent.addListener(e,"click",mxUtils.bind(this,function(e){c.PropertyPanel.EditNodeById(t.cell.id),mxEvent.consume(e),this.destroy()})),t.view.graph.container.appendChild(e),this.images.push(e)}n.prototype.destroy=function(){if(null!=this.images)for(var e=0;e<this.images.length;e++){var t=this.images[e];t.parentNode.removeChild(t)}this.images=null};r.addMouseListener({currentState:null,currentIconSet:null,mouseDown:function(e,t){null!=this.currentState&&(this.dragLeave(t.getEvent(),this.currentState),this.currentState=null)},mouseMove:function(e,t){if(null!=this.currentState&&(t.getState()==this.currentState||null==t.getState())){var n=new mxRectangle(t.getGraphX()-20,t.getGraphY()-20,40,40);if(mxUtils.intersects(n,this.currentState))return}n=r.view.getState(t.getCell());(r.isMouseDown||null!=n&&!r.getModel().isVertex(n.cell))&&(n=null),n!=this.currentState&&(null!=this.currentState&&this.dragLeave(t.getEvent(),this.currentState),this.currentState=n,null!=this.currentState&&this.dragEnter(t.getEvent(),this.currentState))},mouseUp:function(e,t){},dragEnter:function(e,t){null==this.currentIconSet&&(this.currentIconSet=new n(t))},dragLeave:function(e,t){null!=this.currentIconSet&&(this.currentIconSet.destroy(),this.currentIconSet=null)}})},this.ExtendsHook=function(e){var r=e.isCellDisconnectable;e.isCellDisconnectable=function(e,t,n){return r.apply(this,arguments)&&o.editEdges}},this.PermissionApply=function(e,t){o=e},this.Permission=function(e,t,n,r,o){this.editEdges=null==e||e,this.editVertices=null==t||t,this.locked=null!=n&&n,this.createEdges=null==r||r,this.cloneCells=null==o||o},this.Permission.prototype.apply=function(e){e.setConnectable(this.createEdges),e.setCellsLocked(this.locked)},this.GetCurrentGraph=function(){return c.EditType==c.ConstInfo.EnumEditType.Topo&&(graph=c.Property.CoreGraph),c.EditType==c.ConstInfo.EnumEditType.Element&&(graph=c.SubGraph.Graph),graph},this.ConnectHandler=mxUtils.bind(this,function(e,t){var n=t.properties.edge,r=c.Property.CoreGraph;r.getModel();return!!n.target&&(n.source.bigtype==EnxHelper.ModelType.Network&&n.target.bigtype==EnxHelper.ModelType.Network?(r.removeCells([n]),toastr.warning("No connection between the network!"),!1):(n.bigtype=EnxHelper.ModelType.Link,n.style=c.ConstInfo.VirtualLinkStyleName,void setTimeout(function(){r.fireEvent(new mxEventObject(mxEvent.CLICK,"event",t,"cell",n))},100)))}),this.BindEventForMenu=function(){C(".spanEditorBtnSaveImg").off("click").click(function(){c.SaveAsImage()})},this.GetImageUrl=function(){var t="",e=c.GetCurrentGraph(),n=e.getGraphBounds(),r=Math.round(n.x+n.width+4),o=Math.round(n.y+n.height+4),i=mxUtils.getXml(mxUtils.getViewXml(e,1),"\n"),l={height:o,width:r,mxXml:encodeURIComponent(i)};return C.ajax({type:"POST",url:"/Home/EnxToImage",data:JSON.stringify(l),dataType:"json",contentType:"application/json; charset=utf-8",success:function(e){t=e.url,window.open("about:blank").document.write("<img src='"+t+"' alt='No Image'/>")}}),t},this.SaveAsImage=function(){c.GetImageUrl()},this.OnClick=function(e,t){c.EditType=c.ConstInfo.EnumEditType.Topo,c.SelectItemHandle();var n=t.getProperty("cell");u.toggleRightContainer(n),c.PropertyPanel.Hide(),c.SubGraph.EditCell(n)},this.BindEvent=function(){c.Property.CoreGraph.addListener(mxEvent.CLICK,c.OnClick);var e=C(".EplugGraphEditorElementItem,.SubToolbarItem");C.each(e,function(e,t){mxClient.IS_IE&&mxEvent.addListener(t,"dragstart",function(e){e.returnValue=!1}),t.onselectstart=function(){return!1};var n=mxUtils.makeDraggable(t,function(e){return c.EditType=C(t).attr("data-edittype"),c.GetCurrentGraph()},function(e,t,n,r,o){c.DropInElement(e,t,n,r,o,this.dragElement)},t.cloneNode(!0),null,null,c.Property.CoreGraph.autoscroll,!0);n.isGuidesEnabled=function(){return c.Property.CoreGraph.graphHandler.guidesEnabled},n.createDragElement=mxDragSource.prototype.createDragElement}),c.Property.CoreGraph.removeListener(c.ConnectHandler),c.Property.CoreGraph.addListener(mxEvent.CELL_CONNECTED,c.ConnectHandler),c.BindKeyEvent()},this.KeyHandler=function(e){if(!c.Property.CoreGraph.isSelectionEmpty()){var t=0,n=0;37==e?t=-1:38==e?n=-1:39==e?t=1:40==e&&(n=1),c.Property.CoreGraph.moveCells(c.Property.CoreGraph.getSelectionCells(),t,n)}},this.BindKeyEvent=function(){var e=new mxKeyHandler(c.Property.CoreGraph);e.bindKey(13,function(){var e=c.GetCurrentGraph().getSelectionCell();e&&c.PropertyPanel.EditNodeById(e.id)}),e.bindKey(37,function(){c.KeyHandler(37)}),e.bindKey(38,function(){c.KeyHandler(38)}),e.bindKey(39,function(){c.KeyHandler(39)}),e.bindKey(40,function(){c.KeyHandler(40)}),e.bindKey(46,function(){var e=c.GetCurrentGraph().getSelectionCells();c.EditType==c.ConstInfo.EnumEditType.Topo&&c.RemoveSelectCell(e),c.EditType==c.ConstInfo.EnumEditType.Element&&c.SubGraph.RemoveSelectCell(e)}),e.bindControlKey(65,function(){c.selectAll()}),e.bindControlKey(67,function(){c.Copy()}),e.bindControlKey(86,function(){c.Paste()})},this.GetTopDeviceBond=function(e,t,n){return[t,n,62,62]},this.DropInElement=function(e,t,n,r,o,i){var l,a=C(i).attr("data-type"),s={},p=[],d="";if(c.EditType==c.ConstInfo.EnumEditType.Topo&&(e=c.Property.CoreGraph,-1<EnxHelper.ModelTypeOfTopDevice.indexOf(a)&&(s=e.getDefaultParent(),p=c.GetTopDeviceBond(a,r,o))),c.EditType==c.ConstInfo.EnumEditType.Element){var E=n&&n.bigtype||"";E!=EnxHelper.ModelType.Ne||a!=EnxHelper.ModelType.Board&&a!=EnxHelper.ModelType.Port&&a!=EnxHelper.ModelType.VM&&a!=EnxHelper.ModelType.Network?(E==EnxHelper.ModelType.Board||E==EnxHelper.ModelType.VM)&&(a==EnxHelper.ModelType.SubBoard||a==EnxHelper.ModelType.Port)||E==EnxHelper.ModelType.SubBoard&&a==EnxHelper.ModelType.Port?s=n:E!=EnxHelper.ModelType.Tester&&E!=EnxHelper.ModelType.Sftp&&E!=EnxHelper.ModelType.Agent||a!=EnxHelper.ModelType.Port||(s=n):s=n,c.SubGraph.ResetNodeMovable(),e=c.SubGraph.Graph,d=c.ConstInfo.SwimStyle}if(JsonHelper.IsEmptyJson(s))toastr.warning("Subelements are not allowed to add!");else if((l=c.ExcuteDropInElement(e,s,a,p,d)).vertex){var h=C(e.container);h.scrollTop(h.height()),e.setSelectionCell(l),e.fireEvent(new mxEventObject(mxEvent.CLICK,"event",t,"cell",l))}},this.ExcuteDropInElement=function(e,t,n,r,o){var i=JsonHelper.GetStrValue(t,c.ConstInfo.AttrName.OBJNAME),l=JsonHelper.GetStrValue(t,c.ConstInfo.AttrName.CANVASID),a=JsonHelper.GetStrValue(t,c.ConstInfo.AttrName.BIGTYPE),s=u.CreateModel(n,l,i,a),p=r;r&&0!=r.length||(p=c.SubGraph.GetBond(n));var d=this.Translater.JsonToCell(e,s,t,p,o);return c.EditType==c.ConstInfo.EnumEditType.Topo?d.setConnectable(!0):(c.SubGraph.EditGraphCell.vertex?d.setConnectable(!1):d.setConnectable(d.bigtype==EnxHelper.ModelType.Port||d.bigtype==EnxHelper.ModelType.Network),c.SubGraph.SetNodeCannotMove(),e.cellRenderer.redrawLabel(e.view.getState(d))),d},this.InitPopMenu=function(){c.Property.CoreGraph.popupMenuHandler.factoryMethod=function(e,n,t){var r=c.Property.CoreGraph.getSelectionCells(),o=function(e,t){C(e).find("td:last").html('<span class="mxMenu-key">'+t+"</span>")};if(n&&n.edge){var i=n.source.id,l=n.target.id,a=C.grep(r,function(e,t){return e.edge&&e.id!=n.id&&(e.source.id==i&&e.target.id==l||e.target.id==i&&e.source.id==l)});0<a.length&&e.addItem("Group",null,function(){c.CombineLinkToGroup(n,a,!0)},null),n.group&&e.addItem("UnGroup",null,function(){c.PullLinkFromGroup(n)},null)}n&&n.vertex&&o(e.addItem("Copy",null,function(){c.Copy()},null,"mxMenu copy"),"Ctrl+C");if(0<r.length){if(1==r.length)o(e.addItem("Edit",null,function(){c.PropertyPanel.EditNodeById(r[0].id)},null,"mxMenu edit"),"Enter");o(e.addItem("Delete",null,function(){c.RemoveSelectCell(r)},null,"mxMenu delete"),"Del")}else{o(e.addItem("Select All",null,function(){c.selectAll()},null,"mxMenu select"),"Ctrl+A")}n||mxClipboard.isEmpty()||o(e.addItem("Paste",null,function(){c.Paste()},null,"mxMenu paste"),"Ctrl+V")}},this.RemoveSelectCell=function(e){var o=[],i=[];C.each(e,function(e,t){if(t.bigtype==EnxHelper.ModelType.Link){if(o.push(t),t.group){var n=c.GetSameGroupLink(t);o=o.concat(n)}}else{i.push(t);var r=t.edges;r&&C.each(r,function(e,t){u.RemoveModel(EnxHelper.Field.ID,t.id)}),u.RemoveModelByParentId(t.id,!0)}u.RemoveModel(EnxHelper.Field.ID,t.id)}),C.each(o,function(e,t){c.RemoveLink(t,!0)}),c.Property.CoreGraph.removeCells(i,!0),c.SubGraph.EditCell()},this.RemoveCellById=function(e,t){var n=c.Property.CoreGraph,r=[];switch(e){case EnxHelper.ModelType.Link:r=this.GetAllLink(n);break;case EnxHelper.ModelType.Ne:case EnxHelper.ModelType.Tester:case EnxHelper.ModelType.Sftp:case EnxHelper.ModelType.Agent:case EnxHelper.ModelType.Network:case EnxHelper.ModelType.Atm:case EnxHelper.ModelType.Eth:case EnxHelper.ModelType.Sdh:r=this.GetAllNode(n)}if(r&&0!=r.length){var o=JsonHelper.GetJsonByKey(r,"id",t);o.id&&(e==EnxHelper.ModelType.Link?c.RemoveLink(o):n.removeCells([o]))}},this.GetSameGroupLink=function(n){var e=c.GetAllLink(c.Property.CoreGraph);return C.grep(e,function(e,t){return e.edge&&e.group&&e.group==n.group&&e.id!=n.id})},this.SetNodeAttr=function(e,t,n){var r=e.bigtype;u.SetNodeAttr(r,e.id,t,n),e[t]=n[EnxConstField.AttrName.ENXFILE_ATTR_VALUE]},this.RemoveNodeAttr=function(e,t){var n=e.bigtype;u.DeleteNodeAttr(n,e.id,t),delete e[t]},this.CombineLinkToGroup=function(e,t,r){if(t&&0<t.length){c.Property.CoreGraph.toggleCells(!1,t);var n=c.CreateLinkGroupName(e),o=EnxHelper.AttrParameter(c.ConstInfo.AttrName.GROUP,n);c.PushLinkToGroup(e,n),C.each(t,function(e,t){if(r){var n=c.GetSameGroupLink(t);n&&0<n.length&&(c.PullLinkFromGroupStyle(t),C.each(n,function(e,t){c.SetNodeAttr(t,c.ConstInfo.AttrName.GROUP,o)}))}c.SetNodeAttr(t,c.ConstInfo.AttrName.GROUP,o)})}},this.PushLinkToGroup=function(e,t){var n=EnxHelper.AttrParameter(c.ConstInfo.AttrName.GROUP,t);n[EnxConstField.AttrName.ENXFILE_ATTR_GROUPSHOW]="true",c.SetNodeAttr(e,c.ConstInfo.AttrName.GROUP,n),c.Property.CoreGraph.getModel().setValue(e,t),c.Property.CoreGraph.setCellStyle(c.ConstInfo.LinkGroupedStyle,[e]),this.CopyLink(e,!0)},this.CopyLink=function(e,t){t&&c.Property.CoreGraph.removeCells([e]),this.InsertLink(e.parent,e.id,e.value,e.source,e.target,e.style,e.data)},this.InsertLink=function(e,t,n,r,o,i,l){c.Property.CoreGraph.removeListener(c.ConnectHandler),this.Property.CoreGraph.getModel().beginUpdate();try{var a=c.Property.CoreGraph.insertEdge(e,t,n,r,o,i);if(this.AttachCell(a,l),l.group)if(a.group=l.group.value?l.group.value:"",l.group.groupshow){c.Property.CoreGraph.getModel().setValue(a,l.group.value);i=c.ConstInfo.LinkGroupedStyle;a.source.id==a.target.id&&(i=c.ConstInfo.LoopGroupLinkStyleName),c.Property.CoreGraph.setCellStyle(i,[a])}else c.Property.CoreGraph.toggleCells(!1,[a]);else r.id==o.id&&this.Property.CoreGraph.getModel().setStyle(a,c.ConstInfo.LoopLinkStyleName)}finally{this.Property.CoreGraph.getModel().endUpdate()}return c.Property.CoreGraph.addListener(mxEvent.CELL_CONNECTED,c.ConnectHandler),a},this.Copy=function(){var e=c.Property.CoreGraph.getSelectionCells(),t=JsonHelper.FilterListByValues(e,c.ConstInfo.AttrName.VERTEX,[!0]);mxClipboard.copy(c.Property.CoreGraph,t)},this.Paste=function(){var o=c.Property.CoreGraph,e=o.getImportableCells(mxClipboard.getCells());C.each(e,function(e,r){var t=u.CopyModel(r.data);t&&0<t.length&&C.each(t,function(e,t){if(0==e){var n=c.Translater.GetJsonBond(t);n[0]=o.popupMenuHandler.triggerX||n[0]+10,n[1]=o.popupMenuHandler.triggerY||n[1]+10,c.Translater.JsonToCell(o,t,o.getDefaultParent(),n,r.style)}})})},this.selectAll=function(){c.Property.CoreGraph.selectAll()},this.PullLinkFromGroup=function(e){var t=c.GetSameGroupLink(e);C.each(t,function(e,t){c.RemoveNodeAttr(t,c.ConstInfo.AttrName.GROUP)}),c.Property.CoreGraph.toggleCells(!0,t),this.PullLinkFromGroupStyle(e),this.RemoveNodeAttr(e,c.ConstInfo.AttrName.GROUP)},this.PullLinkFromGroupStyle=function(e){var t=c.GetDisplayNodeName(e.data);c.Property.CoreGraph.getModel().setValue(e,t),e.source.id==e.target.id?this.Property.CoreGraph.getModel().setStyle(e,c.ConstInfo.LoopLinkStyleName):c.Property.CoreGraph.setCellStyle(c.ConstInfo.LinkUnGroupStyle,[e])},this.SelectItemHandle=function(){c.Property.CoreGraph.getDefaultParent();var e=c.Property.CoreGraph.getSelectionCells();c.Property.SelectedVertexId=[],c.Property.SelectedLinkId=[],C.each(e,function(e,t){if(t.vertex&&c.Property.SelectedVertexId.push(t[c.ConstInfo.AttrName.ID]),t.edge){c.Property.SelectedLinkId.push(t[c.ConstInfo.AttrName.ID]);var n=c.GetSameGroupLink(t);C.each(n,function(e,t){c.Property.SelectedLinkId.push(t[c.ConstInfo.AttrName.ID])})}})},this.ClearChildren=function(){this.Property.LinkGroupIndex=0,c.Property.CoreGraph&&c.Property.CoreGraph.getModel()&&c.Property.CoreGraph.getModel().root&&c.Property.CoreGraph.getModel().clear()},this.CreateLinkGroupName=function(e){var t="";if(e.group)t=e.group;else{t=this.ConstInfo.LinkGroupPre+this.Property.LinkGroupIndex;this.Property.LinkGroupIndex++}return t},this.ConstInfo=new function(){this.FixWidth=62,this.FixHeight=62,this.AttrName={PARENT:"parent",VALUE:"value",CONNECTABLE:"connectable",ID:"id",SOURCE:"source",STYLE:"style",TARGET:"target",VERTEX:"vertex",GEOMETRY:"geometry",EDGE:"edge",GROUP:"group",OBJNAME:"objname",BIGTYPE:"bigtype",DATA:"data",CANVASID:"canvasID",ISVIRTUALEDGE:"isVirtualEdge"},this.LinkGroupPre="Group",this.ElemntNamePre=new function(){this.Link="link",this.Ne="ne",this.Tester="tester",this.Dev="dev",this.Atm="atm",this.Eth="eth",this.Sdh="sdh",this.Board="board",this.SubBoard="subboard",this.Port="port",this.Network="network",this.Sftp="sftp",this.Agent="agent",this.VM="vm"},this.LinkGroupedStyle="strokeColor=#525ae9;strokeWidth=4;",this.LinkUnGroupStyle="strokeColor=#009b4d;strokeWidth=2;",this.SwimStyle="shape=swimlane;startSize=30;fillColor=#f6f6f6;strokeColor=#f6f6f6;fontColor=#333;",this.UsedPort="shape=swimlane;startSize=30;fillColor=#f6f6f6;strokeColor=#f6f6f6;fontColor=#999;",this.LineDefualtColor="#a5a5a5",this.LoopGroupLinkStyleName="LoopGroupLinkStyleName",this.LoopLinkStyleName="LoopLinkInCoreGraph",this.LoopGroupLinkInCoreGraph="LoopGroupLinkInCoreGraph",this.VirtualLinkStyleName="VirtualLinkStyleName",this.SubGraphHtml='<div id="graphContainer"></div>',this.EnumEditType={Topo:"Topo",Element:"Element",Network:"Network"}},this.EditType=this.ConstInfo.EnumEditType.Topo,this.Init()};return function(e){this.PlugObj={},this.Init=function(e){var t=new n;return t.Init(e),this.BindEvent(t),this.PlugObj=t},this.BindEvent=function(i){C(".spanEditorViewText").off("click").click(function(){i.ViewText()}),C(".spanEditorTopolimit").off("click").click(function(){C(".EPlugTopolimitSubmit").off("click").click(function(){var n=C("#txtTopoLimit").val(),e={BigType:EnxHelper.ModelType.Topolimit,Name:n},r=!1;C.each(i.Property.DataList,function(e,t){t.BigType==EnxHelper.ModelType.Topolimit&&(t.Name=n,r=!0)}),r||i.Property.DataList.push(e),C("#modalTopolimit").modal("hide")}),C(".EPlugTopolimitClose").off("click").click(function(){C("#modalTopolimit").modal("hide")}),C("#txtTopoLimit").val(""),C("#modalTopolimit").modal()}),C(".spanEditorBtnOpenEnx").off("click").click(function(){var o=C("#modalOpenEnx");C(".EPlugImportSubmit").off("click").click(function(){var e=C(".EPlugEnxInput").val(),t=C("#EPlugImportBtn").val();i.Property.FileName=t.substr(t.lastIndexOf("\\")+1);var n=EnxHelper.EnxToLstJson(e);i.SetData(n);var r="";C.each(n,function(e,t){r+=JSON.stringify(t)+"\n\r"}),C(".EPlugEnxInput").val(r),o.modal("hide")}),C(".EPlugImportClose").off("click").click(function(){o.modal("hide")}),C("#EPlugImportBtn").val(""),C(".EPlugEnxInput").val(""),o.modal()}),C(".spanEditorBtnSaveEnx").off("click").click(function(){i.SaveData(!0)}),C("#EPlugImportBtn").off("change").change(function(){if(this.files){var e=this.files[0],t=new FileReader;t.readAsText(e,"UTF-8"),t.onload=function(e){var t=e.target.result;C(".EPlugEnxInput").val(t)}}}),C(".spanEditorBtnExportEnx").off("click").click(function(){i.ExportFile()}),C('[data-toggle="tooltip"]').tooltip(),C(".EplugGraphRightToggle").on("click",function(){i.toggleRightContainer(C(this).hasClass("left"))})},this.Init(e)}});