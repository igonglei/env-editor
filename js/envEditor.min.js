function EPlug(){var e=this;this.Property=new function(){this.ERRCODE_SUCCESS="0x0000",this.DataList=[],this.LstNodeJson=[],this.LstLinkJson=[],this.BusyPortId=[],this.LstPortJson=[],this.ElementId="",this.Element={},this.SelectModelType=EnxHelper.ModelType.Ne,this.CurrentUser="",this.DefaultPDU="SYSTEM",this.CurrentPDU=this.DefaultPDU,this.WebsvcSuffix=".asmx",this.FileAfter=".enx",this.EnxId=EnxHelper.CreateNewGuid(),this.PostUrl=new function(){this.GetById="",this.UpdateById=""},this.GraphPlug={},this.TopoNode={},this.NetworkJson=[],this.SelectOptionValues={vmFlag:["","Fenix_GTR_4U4G100G_01","Fenix_vNE_sFTP_Tester_8U8G90G_01"],network:["","Base1","Base2","Fabric1","Fabric2","OM","External1","External2","External3","External4","External5","External6","ExternalN"],internal_external:["","InternalPort","ExternalPort"],virtual_real:["Virtual","Real"]},this.FileName="",this.ArrTestBedName=[]},this.SetData=function(t){this.ConstInfo.Reset(),this.Property.DataList=t,this.Property.TopoNode=JsonHelper.GetJsonByKey(t,EnxHelper.Field.BigType,EnxHelper.ModelType.Env),this.Property.LstNodeJson=JsonHelper.FilterListByValues(t,EnxHelper.Field.IsTopDevice,[EnxConstField.BoolStr.Yes]),this.Property.LstLinkJson=JsonHelper.FilterListByValues(t,EnxHelper.Field.BigType,[EnxHelper.ModelType.Link]),e.Property.BusyPortId=[],$.each(e.Property.LstLinkJson,function(t,n){var r=JsonHelper.GetStrValue(n[EnxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID],EnxConstField.AttrName.ENXFILE_ATTR_VALUE),o=JsonHelper.GetStrValue(n[EnxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID],EnxConstField.AttrName.ENXFILE_ATTR_VALUE);e.Property.BusyPortId.push(r),e.Property.BusyPortId.push(o)}),this.Property.LstPortJson=JsonHelper.FilterListByValues(t,EnxHelper.Field.BigType,[EnxHelper.ModelType.Port]),this.GraphEditor.Init()},this.GetObjectNameCache=function(){var t={};return e.Property.DataList&&e.Property.DataList.length>0&&$(e.Property.DataList).each(function(e,n){var r=JsonHelper.GetJsonValue(JsonHelper.GetJsonValue(n,EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME),EnxConstField.AttrName.ENXFILE_ATTR_VALUE),o=n[EnxHelper.Field.ID];t[r]=o}),t},this.Init=function(t){var n=EnxHelper.GetQueryString(e.ConstInfo.QueryStringParam.pdu),r=EnxHelper.GetQueryString(e.ConstInfo.QueryStringParam.user),o=EnxHelper.GetQueryString(e.ConstInfo.QueryStringParam.enxId);e.Property.CurrentPDU=n||e.Property.DefaultPDU;var i=e.PduRelUrl[e.Property.CurrentPDU]||e.PduRelUrl[e.Property.DefaultPDU];-1==i.indexOf(e.Property.WebsvcSuffix)?(e.Property.PostUrl.GetById=i+e.ConstInfo.QueryMethod.GetEnvContentByIdNew,e.Property.PostUrl.UpdateById=i+e.ConstInfo.QueryMethod.UpdateDataByIdNew):(e.Property.PostUrl.GetById=i+e.ConstInfo.QueryMethod.GetEnxContentById,e.Property.PostUrl.UpdateById=i+e.ConstInfo.QueryMethod.UpdateDataById),r&&(e.Property.CurrentUser=r),o&&(e.Property.EnxId=o,this.GetEnxContentByID(o)),e.SetData([]),this.OptionParam=$.extend(this.OptionParam,t),this.loadLocalEnx("eca27c53-9fcb-e35a-5405-c75fe9325a15")},this.loadLocalEnx=function(t){var n=$(".EplugGraphEditorRightContainer");n.showLoader(),$.get(dataPath+t+".enx",function(t){e.SetData(EnxHelper.EnxToLstJson(t))}).always(function(){n.hideLoader()})},this.GetEnxContentByID=function(t){var n=[],r="",o=e.Property.CurrentUser,i="GET",l="";-1==e.Property.PostUrl.GetById.indexOf(e.Property.WebsvcSuffix)?e.Property.PostUrl.GetById=EnxHelper.Format(e.Property.PostUrl.GetById,t):(i="POST",l=JSON.stringify({user:o,enxId:t}));var a=e.Property.PostUrl.GetById,s=l,p=JSON.stringify({"X-Auth-UserID":o}),d=$(".EplugGraphEditorRightContainer");d.showLoader(),this.RequestService(i,a,s,p,function(t){d.hideLoader();var o="";if(t&&t.resMessage&&t.errcode==e.Property.ERRCODE_SUCCESS){var i=JSON.parse(t.resMessage);if(-1==e.Property.PostUrl.GetById.indexOf(e.Property.WebsvcSuffix))i&&i.content&&(r=i.content,e.Property.FileName=i.filename,$("#txtTopoLimit").val(i.topolimit));else if(i&&i.d){var l=JSON.parse(i.d).result;l&&(r=l.enx,e.Property.FileName=l.filename)}}else o=t.errcode;o&&toastr.error(o),r&&(n=EnxHelper.EnxToLstJson(r))},function(t,n,r){d.hideLoader();var o=t.statusText;-1==e.Property.PostUrl.GetById.indexOf(e.Property.WebsvcSuffix)&&t.responseText&&(o=o+"\r\n"+(JSON.parse(t.responseText||"{}").message||"")),toastr.error(o)},function(t){e.SetData(n)})},this.GetEnxContent=function(){$.each(e.Property.LstNodeJson,function(t,n){var r=n[EnxHelper.Field.ID],o=n[EnxHelper.Field.BigType],i=e.Property.GraphPlug.GetCellsByFieldValue(o,e.Property.GraphPlug.ConstInfo.AttrName.ID,r),l=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_POSITION,e.Property.GraphPlug.Translater.BondToString(i));n[EnxConstField.AttrName.ENXFILE_ATTR_POSITION]=l});var t=EnxHelper.LstJsonToEnx(e.Property.DataList);return t=t.replace(new RegExp("&lt;","gm"),"<").replace(new RegExp("&gt;","gm"),">").replace(new RegExp("★","gm"),"&quot;").replace(new RegExp("♣","gm"),"&amp;").replace(new RegExp("◀","gm"),"&lt;").replace(new RegExp("▶","gm"),"&gt;")},this.GetPostData=function(){var t=this.GetEnxContent(),n=e.Property.CurrentUser,r=$("#txtTopoLimit").val(),o={},i=e.Property.FileName?e.Property.FileName:e.Property.EnxId+e.Property.FileAfter;if(-1==e.Property.PostUrl.UpdateById.indexOf(e.Property.WebsvcSuffix))o={id:e.Property.EnxId,content:t,filename:i,userid:n,topolimit:r,testbedname:"",testbedcontent:""};else{var l=e.Property.GraphPlug.GetImageUrl();o={user:e.Property.CurrentUser,enxId:e.Property.EnxId,enxContent:t,enxImageUrl:l,fileName:i}}return o},this.SaveData=function(t){var n=e.Property.PostUrl.UpdateById,r=this.GetPostData();if(r&&r.content){var o={"X-Auth-UserID":e.Property.CurrentUser};this.RequestService("POST",n,JSON.stringify(r),JSON.stringify(o),function(n){var r="";if(n&&n.resMessage&&n.errcode==e.Property.ERRCODE_SUCCESS){var o=JSON.parse(n.resMessage);if(-1==e.Property.PostUrl.UpdateById.indexOf(e.Property.WebsvcSuffix))o.result&&"success"==o.result?(e.OpenNewUrl(),t&&toastr.success("Save successfully!")):r=o.message;else{var i=JSON.parse(o.d);i.errcode&&(r=i.errcode)}}else r=n.errcode;t&&r&&toastr.error(r)},function(n,r,o){var i=n.statusText;-1==e.Property.PostUrl.UpdateById.indexOf(e.Property.WebsvcSuffix)&&n.responseText&&(i=i+"\r\n"+(JSON.parse(n.responseText||"{}").message||"")),t&&alertMsg&&toastr.error(i)})}},this.RequestService=function(e,t,n,r,o,i,l){var a=new FormData;a.append("req_type",e),a.append("service_addr",t),a.append("req_content",escape(n)),a.append("headerSet",escape(r)),$.ajax({type:"POST",url:"/Home/RequestService",data:a,dataType:"json",processData:!1,contentType:!1,success:o,error:i,complete:l})},this.ExportFile=function(){xmlContent=this.GetEnxContent();var t=new FormData;t.append("user",e.Property.CurrentUser),t.append("enxId",e.Property.EnxId),t.append("enxContent",escape(xmlContent)),$.ajax({type:"POST",url:"/Home/ExportEnxFile",data:t,dataType:"json",processData:!1,contentType:!1,success:function(t){t&&t.url&&e.OpenNewPage(t.url,void 0,!0),t&&t.errcode&&toastr.error(t.errcode)}})},this.ViewText=function(){xmlContent=this.GetEnxContent();var t=new FormData;t.append("enxId",e.Property.EnxId),t.append("enxContent",escape(xmlContent)),$.ajax({type:"POST",url:"/Home/ViewText",data:t,dataType:"json",processData:!1,contentType:!1,success:function(e){e&&$("#xmpViewText").text(e.content||e.errcode),$("#modalViewText").modal()}})},this.OpenNewPage=function(e,t,n){void 0!=t&&"object"==typeof t&&(e=e+"?"+$.param(t));var r="_blank";if(void 0!=n&&(r="_parent"),$.browser&&$.browser.mozilla)window.location=e;else{var o=document.createElement("a");o.href=e,o.target=r,o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)}},this.OpenNewUrl=function(){var t=e.Property.EnxId,n=(window.location.host,window.location.search.substr(1)),r=[],o=e.ConstInfo.QueryStringParam.enxId,i=o+"="+t;if(n){if(r=n.split("&"),n.indexOf(o)<0)r.push(i);else for(var l=0;l<r.length;l++)if(r[l].indexOf(o)>=0){r[l]=i;break}i=r.join("&")}window.location.search=i},this.GetElement=function(e){return this.Property.Element.find(e)},this.HtmlEditor=new function(){this.GetModelField=function(t,n){var r=e.ConstInfo.AvailableFiled[t];return e.ConstInfo.IsFirstInitAvailField[t]&&!n?this.InitAvailField(t):r},this.InitAvailField=function(t){var n=this.GetModelUnAvailField(t),r=this.GetModelField(t,!0),o=this.GetFirstModelEntity(t),i=JsonHelper.GetJsonAllValue(EnxHelper.Field);e.ConstInfo.IsFirstInitAvailField[t]=!1;var l,a=JsonHelper.IsJsonObj(o);for(var s in o)"string"==typeof(l=a?s:o[s])&&i.indexOf(l)<0&&n.indexOf(l)<0&&r.push(l);return r},this.GetFirstModelEntity=function(t){return e.ConstInfo.DefaultAvailField[t]},this.GetModelUnAvailField=function(t){return e.ConstInfo.UnAvailableFiled[t]}},this.GraphEditor=new function(){this.Init=function(){JsonHelper.IsEmptyJson(e.Property.GraphPlug)?e.Property.GraphPlug=new GraphHelper(e):(e.Property.GraphPlug.ClearChildren(),e.Property.GraphPlug.RenderData())}},this.OptionParam={},this.PduRelUrl={SYSTEM:"http://superlab.huawei.com:7996/",SYSTEM_TEST:"http://localhost:50038/"},this.GetSpecialField=function(t){var n=[];return t==EnxHelper.ModelType.Link&&(n=JsonHelper.GetJsonAllKey(e.ConstInfo.SpecialFieldDic)),n},this.GetDisplayFieldName=function(t){var n=t;return e.ConstInfo.SpecialFieldDic[t]&&(n=e.ConstInfo.SpecialFieldDic[t]),n},this.ConstInfo=new function(){this.Reset=function(){this.IsFirstInitAvailField.Ne=!0,this.IsFirstInitAvailField.Tester=!0,this.IsFirstInitAvailField.Dev=!0,this.IsFirstInitAvailField.Atm=!0,this.IsFirstInitAvailField.Sdh=!0,this.IsFirstInitAvailField.Eth=!0,this.IsFirstInitAvailField.Board=!0,this.IsFirstInitAvailField.SubBoard=!0,this.IsFirstInitAvailField.Link=!0,this.IsFirstInitAvailField.Port=!0,this.IsFirstInitAvailField.Network=!0,this.IsFirstInitAvailField.Sftp=!0,this.IsFirstInitAvailField.Agent=!0,this.IsFirstInitAvailField.VM=!0,this.AvailableFiled.Ne=["roler"],this.Sdh=[],this.Atm=[],this.Eth=[],this.Tester=[],this.Dev=[],this.AvailableFiled.Board=[],this.AvailableFiled.SubBoard=[],this.AvailableFiled.Link=[],this.AvailableFiled.Port=[],this.Network=[],this.Sftp=[],this.Agent=[],this.AvailableFiled.VM=[]},this.REG_IP=new RegExp(/^((25[0-5]|2[0-4]\d|[01]?\d\d?)($|(?!\.$)\.)){4}$/),this.IPINPUTCLASS="EplugIpInput",this.IPINPUTINCORRECTCLASS="EplugIpInputIncorrect",this.IPINPUTINCORRECTTIP="Incorrect:",this.TableDataCheckId="data-checkIds",this.IDSelectorSingal="#",this.ClassSelectorSingal=".",this.IsFirstInitAvailField=new function(){this.Ne=!0,this.Sdh=!0,this.Atm=!0,this.Eth=!0,this.Tester=!0,this.Dev=!0,this.Board=!0,this.SubBoard=!0,this.Link=!0,this.Port=!0,this.Network=!0,this.Sftp=!0,this.Agent=!0,this.VM=!0},this.AvailableFiled=new function(){this.Ne=["roler"],this.Sdh=[],this.Atm=[],this.Eth=[],this.Tester=[],this.Dev=[],this.Board=[],this.SubBoard=[],this.Link=[],this.Port=[],this.Network=[],this.Sftp=[],this.Agent=[],this.VM=[]},this.DefaultAvailField=new function(){this.CommonAvailField=["objname","name","ip","type","version","alias","caption","is_topo","remark"],this.Ne=this.CommonAvailField.concat(["id","console","mask","username","password","ptp","vender","virtual_real","port","cmts_port","cmts_type","olt_version","sub_ip"]),this.Atm=this.CommonAvailField,this.Sdh=this.CommonAvailField,this.Eth=this.CommonAvailField.concat(["actor","bid","sbid","pid","connect_type","engrossstate","groupip","id","mac","username","password","port","portnum","ptp","realNEId","realtype","submask","vender"]),this.Board=this.CommonAvailField.concat(["angle","bid","engrossstate","username","password","portnum","realNEId","slot","virtual_real"]),this.SubBoard=this.CommonAvailField.concat(["bid","sbid","engrossstate","username","password","portnum","realNEId","submask","virtual_real"]),this.Link=this.CommonAvailField.concat(["sourcetopdevicename","sourcedeviceid","targettopdevicename","targetdeviceid","connect_type","direction","parent","cidr","start_ip","end_ip"]),this.Port=this.CommonAvailField.concat(["bid","sbid","pid","shape","submask","interface","host_id","internal_external","virtual_real"]),this.Network=this.CommonAvailField.concat(["cidr","start_ip","end_ip"]),this.VM=this.CommonAvailField.concat(["username","password","vmFlag","cpu_memory","hardDisk","mirror","virtual_real"]),this.Sftp=this.VM,this.Agent=this.VM,this.Tester=this.VM,this.Dev=this.VM},this.UnAvailableFiled=new function(){this.CommonUnAvailField=["name","guid","shape","position","class","fullclass"],this.Ne=this.CommonUnAvailField.concat(["id","bid","connect_type","mac","pid","port","portnum"]),this.Tester=this.CommonUnAvailField,this.Dev=this.CommonUnAvailField,this.Sdh=this.CommonUnAvailField,this.Atm=this.CommonUnAvailField,this.Eth=this.CommonUnAvailField,this.Board=this.CommonUnAvailField,this.SubBoard=this.CommonUnAvailField.concat(["bid"]),this.Link=this.CommonUnAvailField.concat(["dst_port","src_port"]),this.Port=this.CommonUnAvailField,this.Network=this.CommonUnAvailField,this.Sftp=this.CommonUnAvailField,this.Agent=this.CommonUnAvailField,this.VM=this.CommonUnAvailField},this.MinPageSize=10,this.CheckBoxTDFieldName="checkboxelem",this.OperationTDFieldName="operationelem",this.CombineRepalceSingal="(0*\\[[1-9]\\d*\\-[1-9]\\d*\\]|0*[1-9]\\d*\\+|0*\\*)(\\([1-9]\\d*\\))?",this.AllReplaceSingal="\\*",this.NumberRegionSingal="[1-9]\\d*",this.OccupiedPlace="0+",this.RegionReplaceSingal="\\[[1-9]\\d*\\-[1-9]\\d*\\]",this.NumAddSingal="+",this.NumAddReplaceSingal="[1-9]\\d*\\+",this.RegGM="gm",this.AddStep="(\\([1-9]\\d*\\))",this.AddSelfType={NumberAdd:"NumberAdd",Region:"Region",AutoAdd:"AutoAdd"},this.SpecialFieldDic={sourcedeviceid:"src_port",targetdeviceid:"dst_port"},this.SelectField=["vmFlag","network","internal_external","virtual_real"],this.NoEditField=["sourcetopdevicename","targettopdevicename"],this.NoEditTdClass="EPlugNoEditTd",this.QueryStringParam=new function(){this.pdu="pdu",this.user="user",this.enxId="enxId"},this.QueryMethod=new function(){this.GetEnxContentById="GetEnxContentById",this.GetEnvContentByIdNew="api/editor/v1/content/{0}",this.UpdateDataById="UpdateEnxContent",this.UpdateDataByIdNew="api/editor/v1/enx"},this.RepeatedSingal="(1)",this.RepeatedElemtClass="EPlugRepeatName",this.TIME_INTERVAL=null},this.SetNodeAttr=function(e,t,n,r){for(var o=this.GetLstByModelType(e),i=0;i<o.length;i++)if(o[i][EnxHelper.Field.ID]==t){o[i][n]=r;break}},this.DeleteNodeAttr=function(e,t,n){for(var r=this.GetLstByModelType(e),o=0;o<r.length;o++)if(r[o][EnxHelper.Field.ID]==t){delete r[o][n];break}},this.GetLstByModelType=function(t){var n=[];switch(t){case EnxHelper.ModelType.Ne:n=e.Property.LstNodeJson;break;case EnxHelper.ModelType.Link:n=e.Property.LstLinkJson;break;case EnxHelper.ModelType.Port:n=e.Property.LstPortJson}return n},this.CreateModel=function(t,n,r,o,i,l){var a={};a[EnxHelper.Field.BigType]=t,i||(i=EnxHelper.CreateNewGuid()),a[EnxHelper.Field.ID]=i,n&&(a[EnxHelper.Field.ParentGID]=n);var s=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_GUID,i);a[EnxConstField.AttrName.ENXFILE_ATTR_GUID]=s;var p=e.ConstInfo.DefaultAvailField[t],d=EnxHelper.GlobalVar.ElemntIndex[t];if(p){var E=e.ConstInfo.SelectField;$.each(p,function(n,o){var i="";o!=EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME&&o!=EnxConstField.AttrName.ENXFILE_ATTR_NAME||(i=e.Property.GraphPlug.ConstInfo.ElemntNamePre[t]+d,!r||t!=EnxHelper.ModelType.Board&&t!=EnxHelper.ModelType.SubBoard&&t!=EnxHelper.ModelType.Port&&t!=EnxHelper.ModelType.VM||(i=r+EnxConstField.NameSeparate+i)),E.indexOf(o)>-1&&(i=e.Property.SelectOptionValues[o][0]),JsonHelper.IsJsonObj(l)&&l[o]&&(i=l[o]);var s=EnxHelper.AttrParameter(o,i);a[o]=s})}EnxHelper.GlobalVar.ElemntIndex[t]=d+1;var h=o?o+EnxConstField.ClassSeparate:"";switch(t){case EnxHelper.ModelType.Ne:case EnxHelper.ModelType.Sftp:case EnxHelper.ModelType.Agent:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,t),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,t),e.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Network:a[EnxHelper.Field.IsTopDevice]=n&&"Env"!=o?EnxConstField.BoolStr.No:EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,t),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,t),e.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Tester:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_TESTERTYPE),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_TESTERTYPE),e.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Dev:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_DEVTYPE),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_DEVTYPE),e.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Atm:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEATM),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEATM),e.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Sdh:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPESDH),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPESDH),e.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Eth:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.Yes,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEETH),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPEETH),e.Property.LstNodeJson.push(a);break;case EnxHelper.ModelType.Link:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.No,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,EnxConstField.SpecialName.ENXFILE_SPECIAL_UNKOWNTYPECONNECT),e.Property.LstLinkJson.push(a);break;case EnxHelper.ModelType.Board:case EnxHelper.ModelType.SubBoard:case EnxHelper.ModelType.VM:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.No,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,t),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,h+t);case EnxHelper.ModelType.Port:a[EnxHelper.Field.IsTopDevice]=EnxConstField.BoolStr.No,a[EnxConstField.AttrName.ENXFILE_ATTR_CLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_CLASS,t),a[EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS]=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_FULLCLASS,h+t),e.Property.LstPortJson.push(a)}return e.Property.DataList.push(a),a},this.CopyModel=function(t,n,r,o){var i=JSON.parse(JSON.stringify(t)),l=EnxHelper.CreateNewGuid(),a=i[EnxHelper.Field.ID];i[EnxHelper.Field.ID]=l;var s=i[EnxHelper.Field.BigType];n&&(i[EnxHelper.Field.ParentGID]=n);var p=EnxHelper.AttrParameter(EnxConstField.AttrName.ENXFILE_ATTR_GUID,l);i[EnxConstField.AttrName.ENXFILE_ATTR_GUID]=p;var d=[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME,EnxConstField.AttrName.ENXFILE_ATTR_NAME],E=EnxHelper.GlobalVar.ElemntIndex[s],h=e.Property.GraphPlug.ConstInfo.ElemntNamePre[s]+E;switch($.each(d,function(e,t){var n=h;!r||s!=EnxHelper.ModelType.Board&&s!=EnxHelper.ModelType.SubBoard&&s!=EnxHelper.ModelType.Port&&s!=EnxHelper.ModelType.VM||(n=r+EnxConstField.NameSeparate+h),i[t][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=n}),EnxHelper.GlobalVar.ElemntIndex[s]=E+1,s){case EnxHelper.ModelType.Ne:case EnxHelper.ModelType.Tester:case EnxHelper.ModelType.Dev:case EnxHelper.ModelType.Atm:case EnxHelper.ModelType.Sdh:case EnxHelper.ModelType.Eth:e.Property.LstNodeJson.push(i);break;case EnxHelper.ModelType.Link:e.Property.LstLinkJson.push(i);break;case EnxHelper.ModelType.Port:e.Property.LstPortJson.push(i);break;default:e.Property.LstNodeJson.push(i)}e.Property.DataList.push(i);var u=JsonHelper.FilterListByValues(e.Property.DataList,EnxHelper.Field.ParentGID,[a]),c=[i];return $.each(u,function(t,n){var r=e.CopyModel(n,l,h,o);c=c.concat(r)}),c},this.GetLinkByPortId=function(t){for(var n={},r=0;r<e.Property.LstLinkJson.length;r++){var o=e.Property.LstLinkJson[r];if(o.sourcedeviceid.value==t||o.targetdeviceid.value==t){n=o;break}}return n},this.RemoveModelByParentId=function(t,n){var r=this.RemoveModel(EnxHelper.Field.ParentGID,t);n&&$.each(r,function(t,r){e.RemoveModelByParentId(r,n)})},this.RemoveModel=function(t,n){var r=[],o=[];return $.each(e.Property.DataList,function(i,l){var a=l[t];"object"==typeof a&&(a=JsonHelper.GetStrValue(a,EnxConstField.AttrName.ENXFILE_ATTR_VALUE)),a!=n?r.push(l):(e.RemoveModelRelaHandler(l),o.push(JsonHelper.GetStrValue(l,EnxHelper.Field.ID)))}),e.Property.DataList=r,o},this.RemoveModelRelaHandler=function(t){var n=t[EnxHelper.Field.ID];switch(t[EnxHelper.Field.BigType]){case EnxHelper.ModelType.Ne:case EnxHelper.ModelType.Tester:case EnxHelper.ModelType.Dev:case EnxHelper.ModelType.Atm:case EnxHelper.ModelType.Sdh:case EnxHelper.ModelType.Eth:e.Property.LstNodeJson=e.JsonArrDelete(e.Property.LstNodeJson,EnxHelper.Field.ID,n);break;case EnxHelper.ModelType.Link:e.Property.LstLinkJson=e.JsonArrDelete(e.Property.LstLinkJson,EnxHelper.Field.ID,n);var r=JsonHelper.GetStrValue(t[EnxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID],EnxConstField.AttrName.ENXFILE_ATTR_VALUE),o=JsonHelper.GetStrValue(t[EnxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID],EnxConstField.AttrName.ENXFILE_ATTR_VALUE);e.Property.BusyPortId.splice(e.Property.BusyPortId.indexOf(r),1),e.Property.BusyPortId.splice(e.Property.BusyPortId.indexOf(o),1);break;case EnxHelper.ModelType.Port:if(e.Property.LstPortJson=e.JsonArrDelete(e.Property.LstPortJson,EnxHelper.Field.ID,n),e.Property.BusyPortId.indexOf(n)>-1){var i=e.GetLinkByPortId(n);e.RemoveModel(EnxHelper.Field.ID,JsonHelper.GetStrValue(i,EnxHelper.Field.ID))}}},this.GetChildrens=function(t,n){var r=[];return $.each(e.Property.DataList,function(o,i){if(i[EnxHelper.Field.ParentGID]==t&&(r.push(i),n)){var l=e.GetChildrens(i[EnxHelper.Field.ID],n);r=r.concat(l)}}),r},this.JsonArrDelete=function(e,t,n){var r=[];return $.each(e,function(e,o){var i=o[t];"object"==typeof i&&(i=JsonHelper.GetStrValue(i,EnxConstField.AttrName.ENXFILE_ATTR_VALUE)),i!=n&&r.push(o)}),r}}$(function(){EnvEditor.Init()}),$.fn.showLoader&&$.extend($.fn.showLoader.defaults,{color:"#3c8ad8",backgroundColor:"rgba(255,255,255,0.6)"});var plugPath="static/plugins/envEditor/",imgPath=plugPath+"images/",dataPath=plugPath+"data/",EnvEditor=new function(){this.PlugObj={},this.Init=function(e){var t=new EPlug;return t.Init("EPlug_Contain",e),this.BindEvent(t),this.PlugObj=t,t},this.BindEvent=function(e){$(".spanEditorViewText").off("click").click(function(){e.ViewText()}),$(".spanEditorTopolimit").off("click").click(function(){$(".EPlugTopolimitSubmit").off("click").click(function(){var t=$("#txtTopoLimit").val(),n={BigType:EnxHelper.ModelType.Topolimit,Name:t},r=!1;$.each(e.Property.DataList,function(e,n){n.BigType==EnxHelper.ModelType.Topolimit&&(n.Name=t,r=!0)}),r||e.Property.DataList.push(n),$("#modalTopolimit").modal("hide")}),$(".EPlugTopolimitClose").off("click").click(function(){$("#modalTopolimit").modal("hide")}),$("#txtTopoLimit").val(""),$("#modalTopolimit").modal()}),$(".spanEditorBtnOpenEnx").off("click").click(function(){var t=$("#modalOpenEnx");$(".EPlugImportSubmit").off("click").click(function(){var n=$(".EPlugEnxInput").val(),r=$("#EPlugImportBtn").val();e.Property.FileName=r.substr(r.lastIndexOf("\\")+1);var o=EnxHelper.EnxToLstJson(n);e.SetData(o);var i="";$.each(o,function(e,t){i+=JSON.stringify(t)+"\n\r"}),$(".EPlugEnxInput").val(i),t.modal("hide")}),$(".EPlugImportClose").off("click").click(function(){t.modal("hide")}),$("#EPlugImportBtn").val(""),$(".EPlugEnxInput").val(""),t.modal()}),$(".spanEditorBtnSaveEnx").off("click").click(function(){e.SaveData(!0)}),$("#EPlugImportBtn").off("change").change(function(){if(this.files){var e=this.files[0],t=new FileReader;t.readAsText(e,"UTF-8"),t.onload=function(e){var t=e.target.result;$(".EPlugEnxInput").val(t)}}}),$(".spanEditorBtnExportEnx").off("click").click(function(){e.ExportFile()}),$('[data-toggle="tooltip"]').tooltip(),$(".EplugGraphRightToggle").on("click",function(){EnvEditor.toggleRightContainer($(this).hasClass("left"))})},this.toggleRightContainer=function(e){var t=$(".EplugGraphRightToggle"),n=$(".EplugGraphEditorResource"),r=$(".EplugGraphEditorRightContainer"),o=$(".EplugGraphEditorRightTop"),i=t.outerWidth(),l=560-i,a=t.hasClass("left"),s=function(e,i,a,s,p){r.css({"padding-right":s+l}),n.css("width",e),o.css("display",p),t[i]("left").attr("title",a)};e?a&&s(560,"removeClass","Close","+=","block"):a||s(i,"addClass","Open","-=","none")}},GraphHelper=function(e){var t=this,n=null;this.Property=new function(){this.CoreGraph={},this.Contain={},this.SelectedVertexId=[],this.SelectedLinkId=[],this.LinkGroupIndex=1,this.AssistantGraph={},this.Editor={}},this.Init=function(){if(mxClient.isBrowserSupported()){var e=this.Property.Contain=document.getElementById("EplugGraphEditorContainer"),t=this.Property.Editor=new mxEditor;(this.Property.CoreGraph=t.graph).init(e),this.BasicFixSet(),this.RenderData(),this.BindEventForMenu(),this.BindEvent(),this.InitPopMenu(),this.SubGraph.Init(),this.PropertyPanel.Init()}else mxUtils.error("Browser is not supported!",200,!1)},this.GroupLink=function(e){var n=this.GetAllLink(t.Property.CoreGraph),r=JsonHelper.FilterListByValues(n,this.ConstInfo.AttrName.ID,e),o=[];$.each(r,function(e,n){if(o.indexOf(n.id)<0){o.push(n.id);var i=n.source.id,l=n.target.id,a=[],s=n.group&&n.data.group.groupshow;$.each(r,function(e,t){t.id!=n.id&&(t.source.id==i&&t.target.id==l||t.target.id==i&&t.source.id==l)&&(s=s||t.group&&t.data.group.groupshow,a.push(t),o.push(t.id))}),s||t.CombineLinkToGroup(n,a,!1)}})},this.SubGraph=new function(){function n(e,t){this.canSelectNode=null==e||e,this.canMoveVertet=null==t||t}this.Graph={},this.Container={},this.EditGraphCell={};var r=this,o=null;this.Init=function(){r.Container=document.getElementById("EplugGraphEditorSubEditor"),r.Graph=new mxGraph(this.Container),r.BasicFixSet(),r.BindEvent(),r.ConfigureStylesheet(),r.InitPopMenu();var e=r.Graph.isCellMovable;r.Graph.isCellMovable=function(t){return e.apply(this,arguments)&&o.canMoveVertet};var t=r.Graph.isCellSelectable;r.Graph.isCellSelectable=function(e){return!(r.EditGraphCell&&r.EditGraphCell.edge&&!o.canSelectNode&&e.vertex)&&t.apply(this,arguments)}},this.BasicFixSet=function(){this.Graph.cellsResizable=!1,mxConstants.ENTITY_SEGMENT=20,this.Graph.cellsEditable=!1,this.Graph.edgeLabelsMovable=!1,this.Graph.allowDanglingEdges=!1,this.Graph.allowLoops=!1,this.Graph.setConnectable(!0),this.Graph.setDropEnabled(!0),this.Graph.setTooltips(!0),this.Graph.getTooltipForCell=function(e){return e.objname?e.objname:e.value},this.Graph.collapseToPreferredSize=!1,this.Graph.constrainChildren=!1,this.Graph.cellsSelectable=!0,this.Graph.extendParentsOnAdd=!1,this.Graph.extendParents=!1,this.Graph.border=10,this.Graph.keepEdgesInForeground=!0;var e=new mxStackLayout(this.Graph,!0);e.border=this.Graph.border,e.marginBottom=-10,new mxLayoutManager(this.Graph).getLayout=function(t){return t.collapsed?null:(t.parent!=r.Graph.model.root?(e.resizeParent=!0,e.horizontal=!1,e.spacing=10,e.x0=15):(e.resizeParent=!0,e.horizontal=!0,e.spacing=120,e.x0=0),e)},mxConstants.VERTEX_SELECTION_COLOR="#87CEEB",mxConstants.VERTEX_SELECTION_STROKEWIDTH=1.3,mxConstants.VERTEX_SELECTION_DASHED=!1,mxConstants.EDGE_SELECTION_STROKEWIDTH=1.3,mxConstants.HIGHLIGHT_STROKEWIDTH=1.3,mxEvent.disableContextMenu(this.Container),new mxCellTracker(this.Graph,"#87CEEB"),mxConstants.DROP_TARGET_COLOR="#87CEEB",mxConstants.CONNECT_HANDLE_FILLCOLOR="#87CEEB",mxConstants.HANDLE_STROKECOLOR="#87CEEB",mxRectangleShape.prototype.crisp=!0,mxGraphHandler.prototype.guidesEnabled=!0,mxGraph.prototype.expandedImage=null,mxGraph.prototype.collapsedImage=null,mxConnectionHandler.prototype.connectImage=new mxImage(imgPath+"arrow.png",20,20),this.Graph.htmlLabels=!0,this.Graph.getLabel=function(e){var t=this.labelsVisible?this.convertValueToString(e):"";if(e.vertex){var n=t.split("_");return'<div class="subgraph-item-label label-'+e.bigtype+" "+e.using+'" data-id="'+e.id+'">'+n[n.length-1]+"</div>"}return t}},this.ConfigureStylesheet=function(){var e={};e[mxConstants.STYLE_STROKECOLOR]=t.ConstInfo.LineDefualtColor,e[mxConstants.STYLE_STROKEWIDTH]=1.3,e[mxConstants.STYLE_FONTSTYLE]=2,e[mxConstants.STYLE_PERIMETER_SPACING]=0,e[mxConstants.STYLE_ENDARROW]="",e[mxConstants.STYLE_FONTCOLOR]="#5e698a",e[mxConstants.STYLE_FONTSIZE]=12,e[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_BOTTOM,e[mxConstants.STYLE_EDGE]=mxConstants.EDGESTYLE_ENTITY_RELATION,e[mxConstants.STYLE_SEGMENT]=0,this.Graph.getStylesheet().putCellStyle(EnxHelper.ModelType.Link,e)},this.SetPortStatus=function(e,n){r.Graph.getModel().beginUpdate();try{var o=n?t.ConstInfo.SwimStyle:t.ConstInfo.UsedPort;e&&(e.using=n?"":"using",r.Graph.getModel().setStyle(e,o),r.SetCellConnectable(e,n),this.EditGraphCell.vertex&&e.setConnectable(!1))}finally{r.Graph.getModel().endUpdate()}},this.SetLoopLinkPosition=function(e){r.Graph.getModel().beginUpdate();try{e.geometry.points||e.data.sourcetopdevicename.value!=e.data.targettopdevicename.value||(e.geometry.points=[new mxPoint(310,370)])}finally{r.Graph.getModel().endUpdate()}},this.ApplyPermission=function(e){o=e},this.SetNodeCannotMove=function(){this.ApplyPermission(new n(!1,!1))},this.ResetNodeMovable=function(){this.ApplyPermission(new n)},this.EditCell=function(e){r.ApplyPermission(new n),this.SetTopNav(e&&e.data),this.Graph.getModel().clear(),this.EditGraphCell=e,e&&e.vertex?this.RenderNe(e,!0,void 0,!1):e&&e.edge&&this.InitLinkEditor(e),r.ApplyPermission(new n(!0,!1))},this.SetTopNav=function(e){$(".EplugGraphEditorTopNav").css("display",e?"block":"none"),$(".EplugGraphEditorSubEditor").css("padding-top",e?191:130),$(".EplugGraphEditorTopElementName").attr("data-val",e&&e._id||"").text(e&&e.objname&&e.objname.value||"")},this.GetRootDeviceCellInfo=function(e){if(e&&e.data&&e.data.IsTopDevice==EnxConstField.BoolStr.Yes&&e.bigtype==EnxHelper.ModelType.Network)return e;var t=r.Graph.getModel().getParent(e);return!t||t.data&&t.data.IsTopDevice&&t.data.IsTopDevice==EnxConstField.BoolStr.Yes?t:t=this.GetRootDeviceCellInfo(t)},this.ConnectHandler=mxUtils.bind(this,function(n,o){var i=o.properties.edge;if(!i.target)return!1;if(i.source.bigtype==EnxHelper.ModelType.Network&&i.target.bigtype==EnxHelper.ModelType.Network)return t.Property.CoreGraph.removeCells([i]),r.Graph.removeCells([i]),toastr.warning("No connection between the network!"),!1;i.style=EnxHelper.ModelType.Link;var l=r.EditGraphCell.target.data[EnxHelper.Field.ParentGID],a=e.CreateModel(EnxHelper.ModelType.Link,l);a[EnxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=i.source.id,a[EnxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=i.target.id,e.Property.BusyPortId.push(i.source.data.guid.value),e.Property.BusyPortId.push(i.target.data.guid.value),r.SetPortStatus(i.source,!1),r.SetPortStatus(i.target,!1);var s=r.GetRootDeviceCellInfo(i.source),p=r.GetRootDeviceCellInfo(i.target);if(i.source[r.ConstInfo.ROOTDEVICE]=s.data,i.target[r.ConstInfo.ROOTDEVICE]=p.data,a[EnxConstField.AttrName.ENXFILE_ATTR_SOURCETOPDEVICENAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=s.value,a[EnxConstField.AttrName.ENXFILE_ATTR_TARGETTOPDEVICENAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=p.value,t.AttachCell(i,a),r.Graph.getModel().setValue(i,a[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]),r.SetLoopLinkPosition(i),n.connectionHandler.select=!1,r.EditGraphCell.edge){var d=t.GetAllLink(r.Graph,void 0,!0);t.RenderVirtualLink(r.EditGraphCell.source,r.EditGraphCell.target,d)}}),this.InitPopMenu=function(){r.Graph.popupMenuHandler.factoryMethod=function(e,n,o){if(n){var i=r.Graph.getSelectionCells(),l=function(e,t){$(e).find("td:last").html('<span class="mxMenu-key">'+t+"</span>")};1==(i=0==i.length?[n]:i).length&&l(a=e.addItem("Edit",null,function(){t.PropertyPanel.EditNodeById(i[0].id)},null,"mxMenu edit"),"Enter");var a=e.addItem("Delete",null,function(){r.RemoveSelectCell(i)},null,"mxMenu delete");l(a,"Del")}}},this.RemoveSelectCell=function(n){if(0!=(n=n||r.Graph.getSelectionCells()).length){$.each(n,function(t,n){r.RemoveCellRel(n),e.RemoveModelByParentId(n.id,!0),e.RemoveModel(EnxHelper.Field.ID,n.id),e.Property.GraphPlug.RemoveCellById(n.bigtype,n.id)});var o=n[0];o&&o.vertex&&"yes"!=o.data.IsTopDevice&&t.Property.CoreGraph.fireEvent(new mxEventObject(mxEvent.CLICK,"event",null,"cell",r.EditGraphCell)),r.Graph.removeCells(n),0==r.Graph.getChildVertices().length&&r.SetTopNav()}},this.RemoveCellRel=function(n){if(n.edge)return r.SetPortStatus(n.target,!0),void r.SetPortStatus(n.source,!0);var o=[];if(n.bigtype==EnxHelper.ModelType.Port&&e.Property.BusyPortId.indexOf(n.id)>-1)o.push(n);else{var i=t.GetAllNode(r.Graph,n,!0);o=$.grep(i,function(t,n){return t.bigtype==EnxHelper.ModelType.Port&&e.Property.BusyPortId.indexOf(t.id)>-1})}0!=o.length&&$.each(o,function(n,r){var o=$.grep(EnvEditor.PlugObj.Property.LstLinkJson,function(e,t){return e.sourcedeviceid.value==r.id||e.targetdeviceid.value==r.id});if(o&&0!=o.length){var i=o[0]._id;t.RemoveCellById(EnxHelper.ModelType.Link,i),e.RemoveModel(EnxHelper.Field.ID,i)}})},this.InitLinkEditor=function(e){r.Graph.removeListener(r.ConnectHandler);var t,n=e.source,o=e.target;if(t=n.id!=o.id?2:1,this.RenderNe(n,!0,t,!0),n.id!=o.id){this.RenderNe(o,!0,t,!0);var i=r.Graph.getModel().getEdgesBetween(n,o,!1);r.CopyLinkFromCoreGraph(i)}else{var l=r.Graph.getModel().getEdgesBetween(n,n,!1);r.CopyLinkFromCoreGraph(l)}r.Graph.addListener(mxEvent.CELL_CONNECTED,r.ConnectHandler)},this.CopyLinkFromCoreGraph=function(e){if(e&&e.length>0){var n={},o=t.GetAllNode(r.Graph,void 0,!0);$.each(o,function(e,t){t.bigtype!=EnxHelper.ModelType.Port&&t.bigtype!=EnxHelper.ModelType.Network||(n[t.data.guid.value]=t)});var i=r.Graph.getDefaultParent();r.Graph.getModel().beginUpdate();try{$.each(e,function(e,o){var l=o.data;if(l){var a=l[EnxConstField.AttrName.ENXFILE_ATTR_SOURCEDEVICEID][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],s=l[EnxConstField.AttrName.ENXFILE_ATTR_TARGETDEVICEID][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],p=n[a],d=n[s];if(p&&d){r.SetCellConnectable(p,!1),r.SetCellConnectable(d,!1),p[r.ConstInfo.ROOTDEVICE]=o.source.data,d[r.ConstInfo.ROOTDEVICE]=o.target.data;var E=r.Graph.insertEdge(i,o.id,o.objname,n[a],n[s],EnxHelper.ModelType.Link);t.AttachCell(E,o.data),r.SetLoopLinkPosition(E)}}})}finally{r.Graph.getModel().endUpdate()}}},this.SetCellConnectable=function(e,t){e&&e.bigtype!=EnxHelper.ModelType.Network&&e.setConnectable(t)},this.RenderNe=function(n,o,i,l){var a={},s=r.Graph.getDefaultParent();r.Graph.getModel().beginUpdate();try{if(o){var p=JsonHelper.GetJsonByKey(e.Property.LstNodeJson,EnxHelper.Field.ID,n.id),d=r.GetBond(p.BigType),E=t.Translater.JsonToCell(r.Graph,p,s,d,t.ConstInfo.SwimStyle);p.BigType==EnxHelper.ModelType.Network?E.setConnectable(l):E.setConnectable(!1),a=E,e.Property.BusyPortId.indexOf(p.guid.value)>-1&&(E.setConnectable(!1),E.using="using")}else a=s;r.RenderChildCell(n,a,o,i,l)}finally{r.Graph.getModel().endUpdate()}},this.GetBond=function(e){var t=r.ConstInfo.ElementDeaultSet[e];return[0,0,t?t.Width:90,30]},this.RenderChildCell=function(n,o,i,l,a){var s=JsonHelper.GetStrValue(n,t.ConstInfo.AttrName.ID),p=JsonHelper.FilterListByValues(e.Property.DataList,EnxHelper.Field.ParentGID,[s]);$.each(p,function(n,s){if(i&&s.BigType==EnxHelper.ModelType.Port&&s.internal_external&&s.internal_external.value){var p=s.internal_external.value.toLowerCase().indexOf("external");if(1==l&&p>-1)return!0;if(2==l&&-1==p)return!0}var d=r.ConstInfo.ElementDeaultSet[s.BigType].Width,E=t.Translater.JsonToCell(r.Graph,s,o,[0,0,d,30],t.ConstInfo.SwimStyle,i);s.BigType==EnxHelper.ModelType.Network?E.setConnectable(i&&a):E.setConnectable(s.BigType==EnxHelper.ModelType.Port&&i&&a&&e.Property.BusyPortId.indexOf(s.guid.value)<0),e.Property.BusyPortId.indexOf(s.guid.value)>-1&&(r.Graph.getModel().setStyle(E,t.ConstInfo.UsedPort),E.using="using"),r.RenderChildCell(E,E,i,l,a)})},this.BindEvent=function(){r.Graph.addListener(mxEvent.CLICK,function(e,n){t.EditType=t.ConstInfo.EnumEditType.Element,n.properties.cell||t.PropertyPanel.Hide()}),$(".tools-delete").off("click").click(function(){r.RemoveSelectCell()})},this.ConstInfo=new function(){this.ElementDeaultSet=new function(){this.Ne={Width:200},this.Tester={Width:200},this.Dev={Width:200},this.Atm={Width:200},this.Sdh={Width:200},this.Eth={Width:200},this.Sftp={Width:200},this.Network={Width:105},this.Agent={Width:200},this.Board={Width:160},this.VM={Width:160},this.SubBoard={Width:140},this.Port={Width:90}},this.ROOTDEVICE="rootdevice"},this.InsertCell=function(e,n){var o=t.GetAllNode(r.Graph,null,!0),i=JsonHelper.GetJsonByKey(o,t.ConstInfo.AttrName.ID,n);JsonHelper.IsEmptyJson(i)||(t.SubGraph.ResetNodeMovable(),t.ExcuteDropInElement(r.Graph,i,e,[],t.ConstInfo.SwimStyle))}},this.ToggleToolBar=function(e){t.EditType==t.ConstInfo.EnumEditType.Topo?t.EditType=t.ConstInfo.EnumEditType.Element:t.EditType=t.ConstInfo.EnumEditType.Topo,$(".EplugGraphEditorElementItem").hide(),$(".EplugGraphEditorElementItem[data-edittype='"+t.EditType+"']").show(),$(".EplugGraphEditorElementItem[data-edittype='"+t.ConstInfo.EnumEditType.Network+"']").show(),$(".EplugGraphEditorTopMenu span").show(),$(".EplugGraphEditorTopMenu span[data-hidetype='"+t.EditType+"']").hide(),t.EditType!=t.ConstInfo.EnumEditType.Element||!e||e!=EnxHelper.ModelType.Tester&&e!=EnxHelper.ModelType.Dev&&e!=EnxHelper.ModelType.Sftp&&e!=EnxHelper.ModelType.Agent||($(".EplugGraphEditorElementItem").hide(),$(".EplugGraphEditorElementItem[data-type='Port']").show())},this.PropertyPanel=new function(){var t=this;this.EditNodeJson={},this.CustomFields={},this.ElementId="EplugGraphEditorPropertyEditPanel",this.HtmlTemplate=new function(){this.FieldEditItem='<tr data-fieldname="{0}"><td class="EplugGraphEditorPropertyPanelFieldTitle EPlugTextEllipsis">{1}:</td><td><input value="{2}" type="text" class="field_value" /></td></tr>',this.FieldShowItem='<tr data-fieldname="{0}"><td class="EplugGraphEditorPropertyPanelFieldTitle EPlugTextEllipsis">{1}:</td><td><label class="EPlugTextEllipsis EplugGraphEditorPropertyPanelFieldLink" title="{3}" data-val="{2}">{3}</label></td></tr>',this.FieldEditSelItem='<tr data-fieldname="{0}"><td class="EplugGraphEditorPropertyPanelFieldTitle EPlugTextEllipsis">{1}:</td><td><select>{2}</select></td></tr>',this.SelectOptionItem='<option value="{0}" {2}>{1}</option>',this.FieldEditCustomItem='<tr class="custom_field" data-fieldname="{0}"><td><input type="text" class="custom_field_key" placeholder="Key" value="{0}" /><span>:</span></td><td><input type="text" class="custom_field_value field_value" placeholder="Value" value="{1}" /><span class="glyphicon glyphicon-plus custom_field_add" aria-hidden="true" title="Add"></span><span class="glyphicon glyphicon-minus custom_field_delete" aria-hidden="true" title="Delete"></span></td></tr>'},this.Init=function(){this.BindEvent()},this.GetElement=function(e){return $("#"+t.ElementId).find(e)},this.BindEvent=function(){t.GetElement(".EplugGraphEditorPropertyPanelTitleBtn").off("click").click(function(){t.Hide()}),$("#"+t.ElementId).off("change").on("change","input,select",function(){t.updateProperties()})},this.updateProperties=function(){var n=t.GetNodeJson();if(!JsonHelper.IsEmptyJson(n)){$.each(t.CustomFields,function(e,n){delete t.EditNodeJson[e]});var r=JsonHelper.JsonArrSingleUpdate(e.Property.DataList,EnxHelper.Field.ID,EnxConstField.AttrName.ENXFILE_ATTR_VALUE,t.EditNodeJson._id,n);e.Property.GraphPlug.UpdateCell(t.EditNodeJson.BigType,r)}},this.GetNodeJson=function(){var n={};return t.GetElement(".EplugGraphEditorPropertyPanelLst tr").each(function(r,o){var i,l=$(this),a=l.attr("data-fieldname");if(a){var s=l.find("input.field_value");if(s.length>0&&(i=$.trim(s.val()),a==EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME)){var p=e.GetObjectNameCache();p[i]&&p[i]!=t.EditNodeJson._id&&(i+=e.ConstInfo.RepeatedSingal,s.val(i))}var d=$(this).find("select");d.length>0&&(i=d.val()),void 0!==i&&(n[a]=i)}}),n},this.Show=function(){$("#"+t.ElementId).show(200)},this.Hide=function(){this.Reset(),$("#"+t.ElementId).hide(200)},this.Reset=function(){t.GetElement(".EplugGraphEditorPropertyPanelLst").empty()},this.AddField=function(e){var n=EnxHelper.Format(t.HtmlTemplate.FieldEditItem,e,e,"");t.GetElement(".EplugGraphEditorPropertyPanelLst").append(n)},this.AddTr=function(e){t.GetElement(".EplugGraphEditorPropertyPanelLst").append(e)},this.EditNodeById=function(n){if(n&&(t.EditNodeJson=JsonHelper.GetJsonByKey(e.Property.DataList,EnxHelper.Field.ID,n),!JsonHelper.IsEmptyJson(t.EditNodeJson))){t.Show(),t.Reset();var r=t.EditNodeJson.BigType,o=e.HtmlEditor.GetModelField(r),i=e.GetSpecialField(r),l=e.ConstInfo.SelectField;$.each(o,function(n,r){var o=e.GetDisplayFieldName(r),a=JsonHelper.GetJsonValue(t.EditNodeJson,r),s=JsonHelper.GetStrValue(a,EnxConstField.AttrName.ENXFILE_ATTR_VALUE).replace(new RegExp('"',"gm"),"&quot;"),p=s,d="";if(e.ConstInfo.NoEditField.indexOf(r)<0){if(i.indexOf(r)>-1){var E=JsonHelper.GetJsonByKeyAndSecondKey(e.Property.LstPortJson,EnxConstField.AttrName.ENXFILE_ATTR_GUID,EnxConstField.AttrName.ENXFILE_ATTR_VALUE,s);JsonHelper.IsEmptyJson(E)||(p=E[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]),d=$(EnxHelper.Format(t.HtmlTemplate.FieldShowItem,r,o,s,p)),t.BindEventForLink(d)}else if(l.indexOf(r)>-1){var h="",u=e.Property.SelectOptionValues[r];$.each(u,function(e,n){h+=p&&p==n?EnxHelper.Format(t.HtmlTemplate.SelectOptionItem,n,n,"selected='selected'"):EnxHelper.Format(t.HtmlTemplate.SelectOptionItem,n,n,"")}),d=$(EnxHelper.Format(t.HtmlTemplate.FieldEditSelItem,r,o,h))}else d=$(EnxHelper.Format(t.HtmlTemplate.FieldEditItem,r,o,s));t.AddTr(d)}});var a=JsonHelper.GetJsonAllKey(t.EditNodeJson),s=e.HtmlEditor.GetModelUnAvailField(r);s=s.concat(JsonHelper.GetJsonAllValue(EnxHelper.Field),o);var p=$.grep(a,function(e){return-1==$.inArray(e,s)});t.CustomFields={},$.each(p,function(e,n){t.CustomFields[n]=t.EditNodeJson[n].value}),t.InitCustomFields()}},this.BindEventForLink=function(e){e.find(".EplugGraphEditorPropertyPanelFieldLink").off("click").click(function(){var e=$(this).attr("data-val");t.EditNodeById(e)})},this.InitCustomFields=function(){var e=t.CustomFields;$.isEmptyObject(e)?t.AddCustomField():$.each(e,function(e,n){t.AddCustomField(void 0,e,n)})},this.AddCustomField=function(e,n,r){var o=$(EnxHelper.Format(t.HtmlTemplate.FieldEditCustomItem,n||"",r||""));e?e.after(o):t.AddTr(o),t.BindEventForCustomOps(o)},this.BindEventForCustomOps=function(e){e.off("click").on("click",".custom_field_add,.custom_field_delete",function(){$(this).hasClass("custom_field_add")?t.AddCustomField(e):(e.remove(),t.updateProperties())}),e.off("change").on("change",".custom_field_key",function(){var t=$.trim($(this).val());t&&e.attr("data-fieldname",t)})}},this.GetDisplayNodeName=function(e,t){if(!JsonHelper.IsEmptyJson(e)){var n=e[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],r=JsonHelper.GetJsonValue(e,EnxConstField.AttrName.ENXFILE_ATTR_ROLER)[EnxConstField.AttrName.ENXFILE_ATTR_VALUE],o=n;if(e.BigType==EnxHelper.ModelType.Ne&&r&&(o+="("+r+")"),t&&e.BigType==EnxHelper.ModelType.Port){var i=JsonHelper.GetJsonValue(e,EnxConstField.AttrName.ENXFILE_ATTR_INTERFACE)[EnxConstField.AttrName.ENXFILE_ATTR_VALUE];i&&(o=i)}return o}},this.RenderData=function(){this.Property.CoreGraph.getModel().beginUpdate();var n=this.Property.CoreGraph.getDefaultParent();n[this.ConstInfo.AttrName.CANVASID]=e.Property.TopoNode._id,n[this.ConstInfo.AttrName.BIGTYPE]=e.Property.TopoNode.BigType;try{var r={};$.each(e.Property.LstNodeJson,function(e,o){var i=t.Translater.JsonToCell(t.Property.CoreGraph,o,n),l=o[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE];r[l]=i}),$.each(e.Property.LstLinkJson,function(e,o){var i=JsonHelper.GetJsonValue(o,EnxConstField.AttrName.ENXFILE_ATTR_SOURCETOPDEVICENAME)[EnxConstField.AttrName.ENXFILE_ATTR_VALUE],l=JsonHelper.GetJsonValue(o,EnxConstField.AttrName.ENXFILE_ATTR_TARGETTOPDEVICENAME)[EnxConstField.AttrName.ENXFILE_ATTR_VALUE],a=JsonHelper.GetJsonValue(r,i),s=JsonHelper.GetJsonValue(r,l);if(JsonHelper.IsEmptyJson(a)&&JsonHelper.IsEmptyJson(s))return!0;var p=o[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],d=o[EnxHelper.Field.ID];if(t.InsertLink(n,d,p,a,s,EnxHelper.ModelType.Link,o),o.group){var E=o.group.value;t.ResetMaxGroupIndex(E)}})}finally{this.Property.CoreGraph.getModel().endUpdate()}},this.RenderVirtualLink=function(e,n,r){var o=this.GetLinksBetween(e,n,!1),i=this.Property.CoreGraph,l=this;if(i.removeCells(o),r){var a=i.getDefaultParent();i.getModel().beginUpdate();try{$.each(r,function(o,s){var p=s.source.rootdevice._id==e.id?e:n,d=s.target.rootdevice._id==n.id?n:e,E=t.InsertLink(a,s.id,s.objname,p,d,EnxHelper.ModelType.Link,s.data);o==r.length-1&&(i.setSelectionCell(E),l.SubGraph.SetTopNav(E.data))})}finally{i.getModel().endUpdate()}}},this.GetLinksBetween=function(e,t,n){var r=[],r=this.Property.CoreGraph.getModel().getEdgesBetween(e,t,!1);if(n){var o=this.Property.CoreGraph.getModel().getEdgesBetween(e,e,!1);r=r.concat(o);var i=this.Property.CoreGraph.getModel().getEdgesBetween(t,t,!1);r=r.concat(i)}return r},this.RemoveLink=function(n,r){this.Property.CoreGraph.removeCells([n]);var o=this.Property.CoreGraph.getModel().getEdgesBetween(n.source,n.target,!1),i=n.data&&n.data.group&&n.data.group.groupshow,l=[];$.each(o,function(o,a){i&&a.data.group&&a.data.group.value==n.data.group.value&&(r?(t.RemoveLink(a),e.RemoveModel(EnxHelper.Field.ID,a.id)):l.push(a.id))}),l.length>0&&t.GroupLink(l)},this.AttachCell=function(e,n){var r=n[EnxHelper.Field.ID],o=n[EnxHelper.Field.BigType],i=n[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE];e[t.ConstInfo.AttrName.BIGTYPE]=o,e[t.ConstInfo.AttrName.OBJNAME]=i,e[t.ConstInfo.AttrName.DATA]=n,e[t.ConstInfo.AttrName.CANVASID]=r,e[t.ConstInfo.AttrName.ID]=r},this.ResetMaxGroupIndex=function(e){var t=e.match(new RegExp("0|[1-9]\\d*","gm"));t&&t.length>0&&this.Property.LinkGroupIndex<=parseInt(t[t.length-1])&&(this.Property.LinkGroupIndex=parseInt(t[t.length-1])+1)},this.Translater=new function(){this.FixFlex=new function(){this.XAdd=5,this.YAdd=25},this.GetJsonBond=function(e){var n=[0,0,t.ConstInfo.FixWidth,t.ConstInfo.FixHeight],r=JsonHelper.GetJsonValue(e,EnxConstField.AttrName.ENXFILE_ATTR_POSITION)[EnxConstField.AttrName.ENXFILE_ATTR_VALUE];if(r&&r.indexOf(";")>-1){var o=r.split(";"),i=0,l=0;if(o[0].indexOf(",")>-1){var a=o[0].split(",");i=parseInt(a[0])-this.FixFlex.XAdd,l=parseInt(a[1])-this.FixFlex.YAdd}if(o[1].indexOf(",")>-1){var s=o[1].split(",");parseInt(s[0])-this.FixFlex.XAdd,parseInt(s[1])-this.FixFlex.YAdd}n[0]=i,n[1]=l,n[2]=62,n[3]=62}return n},this.BondToString=function(e){var n=e[t.ConstInfo.AttrName.GEOMETRY];n||(n={x:0,y:0,width:0,height:0});var r=n.x+this.FixFlex.XAdd,o=n.y+this.FixFlex.YAdd;return r+","+o+";"+(r+n.width)+","+(o+n.height)},this.JsonToCell=function(e,n,r,o,i,l){if(!$.isEmptyObject(n)){var a=o;o&&0!=o.length||(a=t.Translater.GetJsonBond(n));var s=n[EnxHelper.Field.ID],p=t.GetDisplayNodeName(n,l),d=n[EnxHelper.Field.BigType],E=(n[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],e.insertVertex(r,s,p,a[0],a[1],a[2],a[3],i||d));return t.AttachCell(E,n),E}}},this.ConfigureStylesheet=function(){var e={};e[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_IMAGE,e[mxConstants.STYLE_IMAGE]=imgPath+"v-ne.png",e[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_TOP,e[mxConstants.STYLE_VERTICAL_LABEL_POSITION]=mxConstants.ALIGN_BOTTOM,e[mxConstants.STYLE_FONTCOLOR]="#333",this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Ne,e);var n=$.extend({},e);n[mxConstants.STYLE_IMAGE]=imgPath+"v-tester.png",this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Tester,n);var r=$.extend({},e);r[mxConstants.STYLE_IMAGE]=imgPath+"v-tester.png",this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Dev,r);var o=$.extend({},e);o[mxConstants.STYLE_IMAGE]=imgPath+"v-atm.png",this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Atm,o);var i=$.extend({},e);i[mxConstants.STYLE_IMAGE]=imgPath+"v-eth.png",this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Eth,i);var l=$.extend({},e);l[mxConstants.STYLE_IMAGE]=imgPath+"v-sdh.png",this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Sdh,l);var a=$.extend({},e);a[mxConstants.STYLE_IMAGE]=imgPath+"v-sftp.png",this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Sftp,a);var s=$.extend({},e);s[mxConstants.STYLE_IMAGE]=imgPath+"v-agent.png",this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Agent,s);var p=$.extend({},e);p[mxConstants.STYLE_IMAGE]=imgPath+"v-network.png",this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Network,p);var d={};d[mxConstants.STYLE_STROKECOLOR]=t.ConstInfo.LineDefualtColor,d[mxConstants.STYLE_STROKEWIDTH]=1.3,d[mxConstants.STYLE_FONTSTYLE]=2,d[mxConstants.STYLE_PERIMETER_SPACING]=1,d[mxConstants.STYLE_ENDARROW]="",d[mxConstants.STYLE_FONTCOLOR]="#5e698a",d[mxConstants.STYLE_FONTSIZE]=12,d[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_BOTTOM,this.Property.CoreGraph.getStylesheet().putCellStyle(EnxHelper.ModelType.Link,d);var E=$.extend({},d);E[mxConstants.STYLE_CURVED]=!0,this.Property.CoreGraph.getStylesheet().putCellStyle(t.ConstInfo.LoopLinkStyleName,E);var h=$.extend({},d);h[mxConstants.STYLE_CURVED]=!0,h[mxConstants.STYLE_STROKEWIDTH]=1.3,h[mxConstants.STYLE_STROKECOLOR]="#525ae9",this.Property.CoreGraph.getStylesheet().putCellStyle(t.ConstInfo.LoopGroupLinkStyleName,h);var u=$.extend({},d);u[mxConstants.STYLE_DASHED]=1,this.Property.CoreGraph.getStylesheet().putCellStyle(t.ConstInfo.VirtualLinkStyleName,u)},this.GetAllNode=function(e,n,r){var o=n||e.getDefaultParent(),i=e.getModel().getChildVertices(o);return r&&i&&i.length>0&&$.each(i,function(n,o){var l=t.GetAllNode(e,o,r);i=i.concat(l)}),i},this.GetAllLink=function(e,n,r){var o=[],i=n||e.getDefaultParent(),o=e.getModel().getChildEdges(i);if(r){var l=e.getModel().getChildVertices(i);$.each(l,function(n,i){var l=t.GetAllLink(e,i,r);o=o.concat(l)})}return o},this.GetCellsByFieldValue=function(e,n,r){var o=[];switch(e){case EnxHelper.ModelType.Ne:case EnxHelper.ModelType.Tester:case EnxHelper.ModelType.Dev:case EnxHelper.ModelType.Sdh:case EnxHelper.ModelType.Atm:case EnxHelper.ModelType.Eth:case EnxHelper.ModelType.Board:case EnxHelper.ModelType.SubBoard:case EnxHelper.ModelType.Port:o=this.GetAllNode(t.Property.CoreGraph);break;case EnxHelper.ModelType.Link:o=this.GetAllLink(t.Property.CoreGraph);break;default:o=this.GetAllNode(t.Property.CoreGraph)}return JsonHelper.GetJsonByKey(o,n,r)},this.UpdateCell=function(e,n){var r,o=JsonHelper.GetStrValue(n,EnxHelper.Field.ID),i=n.IsTopDevice==EnxConstField.BoolStr.Yes,l=e==EnxHelper.ModelType.Link;if(i||l)r=t.GetCellsByFieldValue(e,t.ConstInfo.AttrName.ID,o);else{var a=t.GetAllNode(t.SubGraph.Graph,null,!0);r=JsonHelper.GetJsonByKey(a,t.ConstInfo.AttrName.ID,n._id)}if(!JsonHelper.IsEmptyJson(r)){var s=r.objname!=n.objname.value;i&&s&&t.UpdateCellRelChildren(o,r.objname,n.objname.value);var p=t.GetDisplayNodeName(n);r[t.ConstInfo.AttrName.OBJNAME]=n[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE],r[t.ConstInfo.AttrName.DATA]=n,t.Property.CoreGraph.getModel().setValue(r,p),t.SubGraph.Graph.getModel().setValue(r,p),(i&&s||l)&&t.SubGraph.EditCell(r)}},this.UpdateCellRelChildren=function(n,r,o){var i=e.GetChildrens(n,!0);$.each(i,function(e,n){var i=n.objname.value;0==i.indexOf(r)&&i.substr(r.length,1)==EnxConstField.NameSeparate&&(i=i.replace(r,o)),n[EnxConstField.AttrName.ENXFILE_ATTR_OBJNAME][EnxConstField.AttrName.ENXFILE_ATTR_VALUE]=i,t.UpdateCell(n.BigType,n)})},this.BasicFixSet=function(){this.Property.CoreGraph.cellsResizable=!1,this.Property.CoreGraph.cellsEditable=!1,this.Property.CoreGraph.edgeLabelsMovable=!1,this.Property.CoreGraph.allowDanglingEdges=!1,this.Property.CoreGraph.allowLoops=!0,this.Property.CoreGraph.setConnectable(!0),this.Property.CoreGraph.setDropEnabled(!0),this.Property.CoreGraph.setTooltips(!0);var e=new mxParallelEdgeLayout(this.Property.CoreGraph);new mxLayoutManager(this.Property.CoreGraph).getLayout=function(t){if(t.getChildCount()>0)return e},new mxRubberband(this.Property.CoreGraph),t.ConfigureStylesheet(),mxConstants.DEFAULT_FONTFAMILY="Microsoft YaHei",mxConstants.VERTEX_SELECTION_COLOR="#87CEEB",mxConstants.VERTEX_SELECTION_STROKEWIDTH=1.3,mxConstants.VERTEX_SELECTION_DASHED=!1,mxConstants.EDGE_SELECTION_COLOR="#87CEEB",mxConstants.EDGE_SELECTION_DASHED=!1,mxConstants.EDGE_SELECTION_STROKEWIDTH=1.3,mxConstants.DEFAULT_FONTSIZE=14,mxConstants.HIGHLIGHT_STROKEWIDTH=1.3,mxConstants.LOCKED_HANDLE_FILLCOLOR="#87CEEB",mxConstants.HANDLE_STROKECOLOR="#87CEEB",mxEvent.disableContextMenu(this.Property.Contain),new mxCellTracker(this.Property.CoreGraph,"#87CEEB"),mxCellHighlight.prototype.spacing=0,this.Property.CoreGraph.setCellsResizable(!1),this.Property.CoreGraph.setCellsBendable(!1),delete this.Property.CoreGraph.getStylesheet().getDefaultEdgeStyle().endArrow,mxRectangleShape.prototype.crisp=!0,mxGraphHandler.prototype.guidesEnabled=!0,this.PermissionApply(new this.Permission(!1),this.Property.CoreGraph),this.ExtendsHook(this.Property.CoreGraph),this.Property.CoreGraph.getTooltipForCell=function(e){if(e.vertex){var t=e.data;return'<ul class="core_tip"><li><span class="tip_title">Name:</span><span>'+t.objname.value+'</span></li><li><span class="tip_title">IP:</span><span>'+t.ip.value+'</span></li><li><span class="tip_title">Type:</span><span>'+t.type.value+"</span></li></ul>"}return e.value},this.IconSet(this.Property.CoreGraph)},this.IconSet=function(e){function n(e){this.images=[];e.view.graph;var n=mxUtils.createImage(imgPath+"edit.png");n.setAttribute("title","Edit"),n.style.position="absolute",n.style.cursor="pointer",n.style.width="20px",n.style.height="20px",n.style.left=e.x+e.width+"px",n.style.top=e.y-16+"px",mxEvent.addGestureListeners(n,mxUtils.bind(this,function(e){mxEvent.consume(e)})),mxEvent.addListener(n,"click",mxUtils.bind(this,function(n){t.PropertyPanel.EditNodeById(e.cell.id),mxEvent.consume(n),this.destroy()})),e.view.graph.container.appendChild(n),this.images.push(n)}n.prototype.destroy=function(){if(null!=this.images)for(var e=0;e<this.images.length;e++){var t=this.images[e];t.parentNode.removeChild(t)}this.images=null};e.addMouseListener({currentState:null,currentIconSet:null,mouseDown:function(e,t){null!=this.currentState&&(this.dragLeave(t.getEvent(),this.currentState),this.currentState=null)},mouseMove:function(t,n){if(null!=this.currentState&&(n.getState()==this.currentState||null==n.getState())){r=new mxRectangle(n.getGraphX()-20,n.getGraphY()-20,40,40);if(mxUtils.intersects(r,this.currentState))return}var r=e.view.getState(n.getCell());(e.isMouseDown||null!=r&&!e.getModel().isVertex(r.cell))&&(r=null),r!=this.currentState&&(null!=this.currentState&&this.dragLeave(n.getEvent(),this.currentState),this.currentState=r,null!=this.currentState&&this.dragEnter(n.getEvent(),this.currentState))},mouseUp:function(e,t){},dragEnter:function(e,t){null==this.currentIconSet&&(this.currentIconSet=new n(t))},dragLeave:function(e,t){null!=this.currentIconSet&&(this.currentIconSet.destroy(),this.currentIconSet=null)}})},this.ExtendsHook=function(e){var t=e.isCellDisconnectable;e.isCellDisconnectable=function(e,r,o){return t.apply(this,arguments)&&n.editEdges}},this.PermissionApply=function(e,t){n=e},this.Permission=function(e,t,n,r,o){this.editEdges=null==e||e,this.editVertices=null==t||t,this.locked=null!=n&&n,this.createEdges=null==r||r,this.cloneCells=null==o||o},this.Permission.prototype.apply=function(e){e.setConnectable(this.createEdges),e.setCellsLocked(this.locked)},this.GetCurrentGraph=function(){return t.EditType==t.ConstInfo.EnumEditType.Topo&&(graph=t.Property.CoreGraph),t.EditType==t.ConstInfo.EnumEditType.Element&&(graph=t.SubGraph.Graph),graph},this.ConnectHandler=mxUtils.bind(this,function(e,n){var r=n.properties.edge,o=t.Property.CoreGraph;o.getModel();return!!r.target&&(r.source.bigtype==EnxHelper.ModelType.Network&&r.target.bigtype==EnxHelper.ModelType.Network?(o.removeCells([r]),toastr.warning("No connection between the network!"),!1):(r.bigtype=EnxHelper.ModelType.Link,r.style=t.ConstInfo.VirtualLinkStyleName,void setTimeout(function(){o.fireEvent(new mxEventObject(mxEvent.CLICK,"event",n,"cell",r))},100)))}),this.BindEventForMenu=function(){$(".spanEditorBtnSaveImg").off("click").click(function(){t.SaveAsImage()})},this.GetImageUrl=function(){var e="",n=t.GetCurrentGraph(),r=n.getGraphBounds(),o=Math.round(r.x+r.width+4),i=Math.round(r.y+r.height+4),l=mxUtils.getXml(mxUtils.getViewXml(n,1),"\n"),a={height:i,width:o,mxXml:encodeURIComponent(l)};return $.ajax({type:"POST",url:"/Home/EnxToImage",data:JSON.stringify(a),dataType:"json",contentType:"application/json; charset=utf-8",success:function(t){e=t.url,window.open("about:blank").document.write("<img src='"+e+"' alt='No Image'/>")}}),e},this.SaveAsImage=function(){t.GetImageUrl()},this.OnClick=function(e,n){t.EditType=t.ConstInfo.EnumEditType.Topo,t.SelectItemHandle();var r=n.getProperty("cell");EnvEditor.toggleRightContainer(r),t.PropertyPanel.Hide(),t.SubGraph.EditCell(r)},this.BindEvent=function(){t.Property.CoreGraph.addListener(mxEvent.CLICK,t.OnClick);var e=$(".EplugGraphEditorElementItem,.SubToolbarItem");$.each(e,function(e,n){mxClient.IS_IE&&mxEvent.addListener(n,"dragstart",function(e){e.returnValue=!1}),n.onselectstart=function(){return!1};var r=mxUtils.makeDraggable(n,function(e){return t.EditType=$(n).attr("data-edittype"),t.GetCurrentGraph()},function(e,n,r,o,i){t.DropInElement(e,n,r,o,i,this.dragElement)},n.cloneNode(!0),null,null,t.Property.CoreGraph.autoscroll,!0);r.isGuidesEnabled=function(){return t.Property.CoreGraph.graphHandler.guidesEnabled},r.createDragElement=mxDragSource.prototype.createDragElement}),t.Property.CoreGraph.removeListener(t.ConnectHandler),t.Property.CoreGraph.addListener(mxEvent.CELL_CONNECTED,t.ConnectHandler),t.BindKeyEvent()},this.KeyHandler=function(e){if(!t.Property.CoreGraph.isSelectionEmpty()){var n=0,r=0;37==e?n=-1:38==e?r=-1:39==e?n=1:40==e&&(r=1),t.Property.CoreGraph.moveCells(t.Property.CoreGraph.getSelectionCells(),n,r)}},this.BindKeyEvent=function(){var e=new mxKeyHandler(t.Property.CoreGraph);e.bindKey(13,function(){var e=t.GetCurrentGraph().getSelectionCell();e&&t.PropertyPanel.EditNodeById(e.id)}),e.bindKey(37,function(){t.KeyHandler(37)}),e.bindKey(38,function(){t.KeyHandler(38)}),e.bindKey(39,function(){t.KeyHandler(39)}),e.bindKey(40,function(){t.KeyHandler(40)}),e.bindKey(46,function(){var e=t.GetCurrentGraph().getSelectionCells();t.EditType==t.ConstInfo.EnumEditType.Topo&&t.RemoveSelectCell(e),t.EditType==t.ConstInfo.EnumEditType.Element&&t.SubGraph.RemoveSelectCell(e)}),e.bindControlKey(65,function(){t.selectAll()}),e.bindControlKey(67,function(){t.Copy()}),e.bindControlKey(86,function(){t.Paste()})},this.GetTopDeviceBond=function(e,t,n){return[t,n,62,62]},this.DropInElement=function(e,n,r,o,i,l){var a=$(l).attr("data-type"),s={},p={},d=[],E="";if(t.EditType==t.ConstInfo.EnumEditType.Topo&&(e=t.Property.CoreGraph,EnxHelper.ModelTypeOfTopDevice.indexOf(a)>-1&&(p=e.getDefaultParent(),d=t.GetTopDeviceBond(a,o,i))),t.EditType==t.ConstInfo.EnumEditType.Element){var h=r&&r.bigtype||"";h!=EnxHelper.ModelType.Ne||a!=EnxHelper.ModelType.Board&&a!=EnxHelper.ModelType.Port&&a!=EnxHelper.ModelType.VM&&a!=EnxHelper.ModelType.Network?(h==EnxHelper.ModelType.Board||h==EnxHelper.ModelType.VM)&&(a==EnxHelper.ModelType.SubBoard||a==EnxHelper.ModelType.Port)||h==EnxHelper.ModelType.SubBoard&&a==EnxHelper.ModelType.Port?p=r:h!=EnxHelper.ModelType.Tester&&h!=EnxHelper.ModelType.Sftp&&h!=EnxHelper.ModelType.Agent||a!=EnxHelper.ModelType.Port||(p=r):p=r,t.SubGraph.ResetNodeMovable(),e=t.SubGraph.Graph,E=t.ConstInfo.SwimStyle}if(JsonHelper.IsEmptyJson(p))toastr.warning("Subelements are not allowed to add!");else if((s=t.ExcuteDropInElement(e,p,a,d,E)).vertex){var u=$(e.container);u.scrollTop(u.height()),e.setSelectionCell(s),e.fireEvent(new mxEventObject(mxEvent.CLICK,"event",n,"cell",s))}},this.ExcuteDropInElement=function(n,r,o,i,l){var a=JsonHelper.GetStrValue(r,t.ConstInfo.AttrName.OBJNAME),s=JsonHelper.GetStrValue(r,t.ConstInfo.AttrName.CANVASID),p=JsonHelper.GetStrValue(r,t.ConstInfo.AttrName.BIGTYPE),d=e.CreateModel(o,s,a,p),E=i;i&&0!=i.length||(E=t.SubGraph.GetBond(o));var h=this.Translater.JsonToCell(n,d,r,E,l);return t.EditType==t.ConstInfo.EnumEditType.Topo?h.setConnectable(!0):(t.SubGraph.EditGraphCell.vertex?h.setConnectable(!1):h.setConnectable(h.bigtype==EnxHelper.ModelType.Port||h.bigtype==EnxHelper.ModelType.Network),t.SubGraph.SetNodeCannotMove(),n.cellRenderer.redrawLabel(n.view.getState(h))),h},this.InitPopMenu=function(){t.Property.CoreGraph.popupMenuHandler.factoryMethod=function(e,n,r){var o=t.Property.CoreGraph.getSelectionCells(),i=function(e,t){$(e).find("td:last").html('<span class="mxMenu-key">'+t+"</span>")};if(n&&n.edge){var l=n.source.id,a=n.target.id,s=$.grep(o,function(e,t){return e.edge&&e.id!=n.id&&(e.source.id==l&&e.target.id==a||e.target.id==l&&e.source.id==a)});s.length>0&&e.addItem("Group",null,function(){t.CombineLinkToGroup(n,s,!0)},null),n.group&&e.addItem("UnGroup",null,function(){t.PullLinkFromGroup(n)},null)}if(n&&n.vertex&&i(p=e.addItem("Copy",null,function(){t.Copy()},null,"mxMenu copy"),"Ctrl+C"),o.length>0?(1==o.length&&i(p=e.addItem("Edit",null,function(){t.PropertyPanel.EditNodeById(o[0].id)},null,"mxMenu edit"),"Enter"),i(p=e.addItem("Delete",null,function(){t.RemoveSelectCell(o)},null,"mxMenu delete"),"Del")):i(p=e.addItem("Select All",null,function(){t.selectAll()},null,"mxMenu select"),"Ctrl+A"),!n&&!mxClipboard.isEmpty()){var p=e.addItem("Paste",null,function(){t.Paste()},null,"mxMenu paste");i(p,"Ctrl+V")}}},this.RemoveSelectCell=function(n){var r=[],o=[];$.each(n,function(n,i){if(i.bigtype==EnxHelper.ModelType.Link){if(r.push(i),i.group){var l=t.GetSameGroupLink(i);r=r.concat(l)}}else{o.push(i);var a=i.edges;a&&$.each(a,function(t,n){e.RemoveModel(EnxHelper.Field.ID,n.id)}),e.RemoveModelByParentId(i.id,!0)}e.RemoveModel(EnxHelper.Field.ID,i.id)}),$.each(r,function(e,n){t.RemoveLink(n,!0)}),t.Property.CoreGraph.removeCells(o,!0),t.SubGraph.EditCell()},this.RemoveCellById=function(e,n){var r=t.Property.CoreGraph,o=[];switch(e){case EnxHelper.ModelType.Link:o=this.GetAllLink(r);break;case EnxHelper.ModelType.Ne:case EnxHelper.ModelType.Tester:case EnxHelper.ModelType.Sftp:case EnxHelper.ModelType.Agent:case EnxHelper.ModelType.Network:case EnxHelper.ModelType.Atm:case EnxHelper.ModelType.Eth:case EnxHelper.ModelType.Sdh:o=this.GetAllNode(r)}if(o&&0!=o.length){var i=JsonHelper.GetJsonByKey(o,"id",n);i.id&&(e==EnxHelper.ModelType.Link?t.RemoveLink(i):r.removeCells([i]))}},this.GetSameGroupLink=function(e){var n=t.GetAllLink(t.Property.CoreGraph);return $.grep(n,function(t,n){return t.edge&&t.group&&t.group==e.group&&t.id!=e.id})},this.SetNodeAttr=function(t,n,r){var o=t.bigtype;e.SetNodeAttr(o,t.id,n,r),t[n]=r[EnxConstField.AttrName.ENXFILE_ATTR_VALUE]},this.RemoveNodeAttr=function(t,n){var r=t.bigtype;e.DeleteNodeAttr(r,t.id,n),delete t[n]},this.CombineLinkToGroup=function(e,n,r){if(n&&n.length>0){t.Property.CoreGraph.toggleCells(!1,n);var o=t.CreateLinkGroupName(e),i=EnxHelper.AttrParameter(t.ConstInfo.AttrName.GROUP,o);t.PushLinkToGroup(e,o),$.each(n,function(e,n){if(r){var o=t.GetSameGroupLink(n);o&&o.length>0&&(t.PullLinkFromGroupStyle(n),$.each(o,function(e,n){t.SetNodeAttr(n,t.ConstInfo.AttrName.GROUP,i)}))}t.SetNodeAttr(n,t.ConstInfo.AttrName.GROUP,i)})}},this.PushLinkToGroup=function(e,n){var r=EnxHelper.AttrParameter(t.ConstInfo.AttrName.GROUP,n);r[EnxConstField.AttrName.ENXFILE_ATTR_GROUPSHOW]="true",t.SetNodeAttr(e,t.ConstInfo.AttrName.GROUP,r),t.Property.CoreGraph.getModel().setValue(e,n),t.Property.CoreGraph.setCellStyle(t.ConstInfo.LinkGroupedStyle,[e]),this.CopyLink(e,!0)},this.CopyLink=function(e,n){n&&t.Property.CoreGraph.removeCells([e]),this.InsertLink(e.parent,e.id,e.value,e.source,e.target,e.style,e.data)},this.InsertLink=function(e,n,r,o,i,l,a){t.Property.CoreGraph.removeListener(t.ConnectHandler),this.Property.CoreGraph.getModel().beginUpdate();try{var s=t.Property.CoreGraph.insertEdge(e,n,r,o,i,l);if(this.AttachCell(s,a),a.group)if(s.group=a.group.value?a.group.value:"",a.group.groupshow){t.Property.CoreGraph.getModel().setValue(s,a.group.value);var l=t.ConstInfo.LinkGroupedStyle;s.source.id==s.target.id&&(l=t.ConstInfo.LoopGroupLinkStyleName),t.Property.CoreGraph.setCellStyle(l,[s])}else t.Property.CoreGraph.toggleCells(!1,[s]);else o.id==i.id&&this.Property.CoreGraph.getModel().setStyle(s,t.ConstInfo.LoopLinkStyleName)}finally{this.Property.CoreGraph.getModel().endUpdate()}return t.Property.CoreGraph.addListener(mxEvent.CELL_CONNECTED,t.ConnectHandler),s},this.Copy=function(){var e=t.Property.CoreGraph.getSelectionCells(),n=JsonHelper.FilterListByValues(e,t.ConstInfo.AttrName.VERTEX,[!0]);mxClipboard.copy(t.Property.CoreGraph,n)},this.Paste=function(){var n=t.Property.CoreGraph,r=n.getImportableCells(mxClipboard.getCells());$.each(r,function(r,o){var i=e.CopyModel(o.data);i&&i.length>0&&$.each(i,function(e,r){if(0==e){var i=t.Translater.GetJsonBond(r);i[0]=n.popupMenuHandler.triggerX||i[0]+10,i[1]=n.popupMenuHandler.triggerY||i[1]+10,t.Translater.JsonToCell(n,r,n.getDefaultParent(),i,o.style)}})})},this.selectAll=function(){t.Property.CoreGraph.selectAll()},this.PullLinkFromGroup=function(e){var n=t.GetSameGroupLink(e);$.each(n,function(e,n){t.RemoveNodeAttr(n,t.ConstInfo.AttrName.GROUP)}),t.Property.CoreGraph.toggleCells(!0,n),this.PullLinkFromGroupStyle(e),this.RemoveNodeAttr(e,t.ConstInfo.AttrName.GROUP)},this.PullLinkFromGroupStyle=function(e){var n=t.GetDisplayNodeName(e.data);t.Property.CoreGraph.getModel().setValue(e,n),e.source.id==e.target.id?this.Property.CoreGraph.getModel().setStyle(e,t.ConstInfo.LoopLinkStyleName):t.Property.CoreGraph.setCellStyle(t.ConstInfo.LinkUnGroupStyle,[e])},this.SelectItemHandle=function(){t.Property.CoreGraph.getDefaultParent();var e=t.Property.CoreGraph.getSelectionCells();t.Property.SelectedVertexId=[],t.Property.SelectedLinkId=[],$.each(e,function(e,n){if(n.vertex&&t.Property.SelectedVertexId.push(n[t.ConstInfo.AttrName.ID]),n.edge){t.Property.SelectedLinkId.push(n[t.ConstInfo.AttrName.ID]);var r=t.GetSameGroupLink(n);$.each(r,function(e,n){t.Property.SelectedLinkId.push(n[t.ConstInfo.AttrName.ID])})}})},this.ClearChildren=function(){this.Property.LinkGroupIndex=0,t.Property.CoreGraph&&t.Property.CoreGraph.getModel()&&t.Property.CoreGraph.getModel().root&&t.Property.CoreGraph.getModel().clear()},this.CreateLinkGroupName=function(e){t="";if(e.group)t=e.group;else{var t=this.ConstInfo.LinkGroupPre+this.Property.LinkGroupIndex;this.Property.LinkGroupIndex++}return t},this.ConstInfo=new function(){this.FixWidth=62,this.FixHeight=62,this.AttrName={PARENT:"parent",VALUE:"value",CONNECTABLE:"connectable",ID:"id",SOURCE:"source",STYLE:"style",TARGET:"target",VERTEX:"vertex",GEOMETRY:"geometry",EDGE:"edge",GROUP:"group",OBJNAME:"objname",BIGTYPE:"bigtype",DATA:"data",CANVASID:"canvasID",ISVIRTUALEDGE:"isVirtualEdge"},this.LinkGroupPre="Group",this.ElemntNamePre=new function(){this.Link="link",this.Ne="ne",this.Tester="tester",this.Dev="dev",this.Atm="atm",this.Eth="eth",this.Sdh="sdh",this.Board="board",this.SubBoard="subboard",this.Port="port",this.Network="network",this.Sftp="sftp",this.Agent="agent",this.VM="vm"},this.LinkGroupedStyle="strokeColor=#525ae9;strokeWidth=4;",this.LinkUnGroupStyle="strokeColor=#009b4d;strokeWidth=2;",this.SwimStyle="shape=swimlane;startSize=30;fillColor=#f6f6f6;strokeColor=#f6f6f6;fontColor=#333;",this.UsedPort="shape=swimlane;startSize=30;fillColor=#f6f6f6;strokeColor=#f6f6f6;fontColor=#999;",this.LineDefualtColor="#a5a5a5",this.LoopGroupLinkStyleName="LoopGroupLinkStyleName",this.LoopLinkStyleName="LoopLinkInCoreGraph",this.LoopGroupLinkInCoreGraph="LoopGroupLinkInCoreGraph",this.VirtualLinkStyleName="VirtualLinkStyleName",this.SubGraphHtml='<div id="graphContainer"></div>',this.EnumEditType={Topo:"Topo",Element:"Element",Network:"Network"}},this.EditType=this.ConstInfo.EnumEditType.Topo,this.Init()};